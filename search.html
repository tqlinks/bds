<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√¨m Ki·∫øm v√† Qu·∫£n L√Ω B·∫•t ƒê·ªông S·∫£n</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <style>
        /* CSS C∆† B·∫¢N V√Ä MODAL */
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 1200px; margin: auto; }
        .column { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; }
        .filter-group { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
        .filter-item { flex: 1; min-width: 150px; }
        .filter-item label { display: block; margin-bottom: 5px; font-weight: bold; }
        .filter-item input[type="text"], .filter-item input[type="number"], .filter-item select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .filter-item-checkbox { align-self: flex-end; padding-bottom: 5px; }
        .form-group-checkbox { display: flex; align-items: center; gap: 10px; height: 40px; margin-top: 25px; }
        .property-item { border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; padding: 15px; display: flex; gap: 15px; align-items: flex-start; background-color: #fafafa; position: relative; }
        .property-actions { position: absolute; top: 10px; right: 10px; display: flex; flex-direction: column; gap: 5px; }
        .property-images { display: flex; gap: 5px; flex-wrap: wrap; max-width: 150px; cursor: pointer; border: 1px solid #ccc; padding: 5px; border-radius: 4px; margin-top: 5px; }
        .property-images img { max-width: 100%; height: 70px; width: auto; border-radius: 4px; object-fit: cover; }
        .property-details-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px 10px; margin-top: 10px; font-size: 0.9em; }
        .delete-btn { background-color: #dc3545; padding: 5px 10px; font-size: 14px; border: none; border-radius: 4px; cursor: pointer; }
        .edit-details-btn { background-color: #ffc107; color: #333; padding: 5px 10px; font-size: 14px; border: none; border-radius: 4px; cursor: pointer; }
        .action-link { text-decoration: none; padding: 10px 15px; border-radius: 4px; font-size: 16px; margin-left: 10px; float: right; }
        
        /* Modal Styles */
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; padding: 20px; border-radius: 8px; width: 90%; max-width: 900px; position: relative; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); max-height: 90vh; overflow-y: auto; }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; top: 10px; right: 20px; z-index: 1001; background: rgba(255, 255, 255, 0.5); border-radius: 50%; padding: 0 8px; }
        .current-images-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
        .image-wrapper { position: relative; overflow: hidden; border-radius: 4px; }
        .image-wrapper img { width: 100%; height: 120px; object-fit: cover; display: block; }
        .delete-image-btn { position: absolute; top: 5px; right: 5px; background: rgba(255, 0, 0, 0.8); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px; line-height: 1; text-align: center; padding: 0; }
        .new-images-preview { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .new-images-preview img { max-width: 80px; height: 80px; object-fit: cover; border: 1px solid #007bff; border-radius: 4px; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group select { padding: 8px; }

    </style>
</head>
<body>

<div class="container">
    <div class="column">
        <div style="margin-bottom: 20px;">
            <a href="input.html" id="input-link" class="action-link" style="background-color: #28a745; color: white; display: none;">
                ‚ûï Nh·∫≠p Th√¥ng Tin M·ªõi
            </a>
            <a href="#" onclick="logout()" id="logout-btn" class="action-link" style="background-color: #dc3545; color: white; display: none;">
                ƒêƒÉng Xu·∫•t
            </a>
            <a href="login.html" id="login-link" class="action-link" style="background-color: #007bff; color: white;">
                üîí ƒêƒÉng Nh·∫≠p Admin
            </a>
        </div>

        <h2>üîç T√¨m Ki·∫øm Chi Ti·∫øt</h2>
        <div class="filter-group">
            <div class="filter-item"><label for="filter-name">T√™n / Ti√™u ƒë·ªÅ:</label><input type="text" id="filter-name" placeholder="T√¨m ki·∫øm theo T√™n..." onkeyup="searchProperties()"></div>
            <div class="filter-item"><label for="filter-phone">S·ªë ƒëi·ªán tho·∫°i:</label><input type="text" id="filter-phone" placeholder="T√¨m ki·∫øm theo SƒêT..." onkeyup="searchProperties()"></div>
            <div class="filter-item"><label for="filter-address">ƒê·ªãa ch·ªâ:</label><input type="text" id="filter-address" placeholder="T√¨m ki·∫øm theo ƒê·ªãa ch·ªâ..." onkeyup="searchProperties()"></div>
        </div>
        
        <div class="filter-group">
            <div class="filter-item"><label for="filter-price-min">Gi√° min (t·ª∑ VNƒê):</label><input type="number" id="filter-price-min" step="0.01" placeholder="Min Gi√°..." onkeyup="searchProperties()"></div>
            <div class="filter-item"><label for="filter-price-max">Gi√° max (t·ª∑ VNƒê):</label><input type="number" id="filter-price-max" step="0.01" placeholder="Max Gi√°..." onkeyup="searchProperties()"></div>
            <div class="filter-item"><label for="filter-area-min">Di·ªán t√≠ch min (m¬≤):</label><input type="number" id="filter-area-min" step="0.1" placeholder="Min Di·ªán t√≠ch..." onkeyup="searchProperties()"></div>
        </div>

        <div class="filter-group">
            <div class="filter-item"><label for="filter-direction">H∆∞·ªõng Nh√†:</label><select id="filter-direction" onchange="searchProperties()"><option value="">T·∫•t c·∫£</option><option value="ƒê√¥ng">ƒê√¥ng</option><option value="T√¢y">T√¢y</option><option value="Nam">Nam</option><option value="B·∫Øc">B·∫Øc</option><option value="ƒê√¥ng-B·∫Øc">ƒê√¥ng-B·∫Øc</option><option value="ƒê√¥ng-Nam">ƒê√¥ng-Nam</option><option value="T√¢y-B·∫Øc">T√¢y-B·∫Øc</option><option value="T√¢y-Nam">T√¢y-Nam</option></select></div>
            <div class="filter-item"><label for="filter-legal">T√¨nh tr·∫°ng S·ªï:</label><select id="filter-legal" onchange="searchProperties()"><option value="">T·∫•t c·∫£</option><option value="S·ªï H·ªìng">S·ªï H·ªìng</option><option value="S·ªï ƒê·ªè">S·ªï ƒê·ªè</option><option value="H·ª£p ƒê·ªìng Mua B√°n">H·ª£p ƒê·ªìng Mua B√°n</option><option value="Ch∆∞a c√≥ S·ªï">Ch∆∞a c√≥ S·ªï</option></select></div>
            <div class="filter-item filter-item-checkbox"><div class="form-group-checkbox"><input type="checkbox" id="filter-loanable" onchange="searchProperties()"><label for="filter-loanable">Ch·ªâ hi·ªán BƒêS c√≥ th·ªÉ vay</label></div></div>
        </div>

        <div class="filter-group">
            <div class="filter-item"><label for="filter-bedrooms-min">PN t·ªëi thi·ªÉu:</label><input type="number" id="filter-bedrooms-min" min="0" placeholder="Min PN" onkeyup="searchProperties()"></div>
            <div class="filter-item"><label for="filter-wc-min">WC t·ªëi thi·ªÉu:</label><input type="number" id="filter-wc-min" min="0" placeholder="Min WC" onkeyup="searchProperties()"></div>
            <div class="filter-item"><label for="filter-floors-min">L·∫ßu t·ªëi thi·ªÉu:</label><input type="number" id="filter-floors-min" min="0" placeholder="Min L·∫ßu" onkeyup="searchProperties()"></div>
        </div>

        <h3>Danh s√°ch K·∫øt qu·∫£ (<span id="result-count">0</span> BƒêS)</h3>
        <ul id="results-list">
        </ul>
    </div>
</div>

<div id="imageModal" class="modal-overlay" onclick="if(event.target.id === 'imageModal') closeModal('imageModal')">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('imageModal')">&times;</span>
        <h3 id="modal-title">C·∫≠p nh·∫≠t H√¨nh ·∫£nh</h3>
        
        <input type="hidden" id="current-property-id">

        <h4>·∫¢nh Hi·ªán T·∫°i (B·∫•m X ƒë·ªÉ x√≥a)</h4>
        <div id="modal-gallery" class="current-images-grid"></div>

        <h4 style="margin-top: 20px;">Th√™m ·∫¢nh M·ªõi</h4>
        <div class="form-group-inline">
            <div class="inline-item">
                <input type="file" id="update-image-upload" accept="image/*" multiple>
            </div>
        </div>
        
        <div class="new-images-preview" id="new-images-preview"></div>

        <button onclick="saveUpdatedImages()" style="margin-top: 15px; width: 100%;">L∆∞u C·∫≠p Nh·∫≠t ·∫¢nh</button>
    </div>
</div>

<div id="detailsModal" class="modal-overlay" onclick="if(event.target.id === 'detailsModal') closeModal('detailsModal')">
    <div class="modal-content" style="max-width: 600px;">
        <span class="modal-close" onclick="closeModal('detailsModal')">&times;</span>
        <h3 style="color: #ffc107;">‚úèÔ∏è S·ª≠a Th√¥ng Tin Chi Ti·∫øt</h3>
        
        <input type="hidden" id="edit-property-id">

        <form onsubmit="event.preventDefault(); savePropertyDetails();">
            <div class="form-group"><label for="edit-name">T√™n / Ti√™u ƒë·ªÅ:</label><input type="text" id="edit-name" placeholder="Ti√™u ƒë·ªÅ"></div>
            <div class="form-group-inline"><div class="inline-item"><label for="edit-price">Gi√° (t·ª∑):</label><input type="number" id="edit-price" step="0.01" placeholder="Gi√°"></div><div class="inline-item"><label for="edit-area">Di·ªán t√≠ch (m¬≤):</label><input type="number" id="edit-area" step="0.1" placeholder="Di·ªán t√≠ch"></div></div>
            <div class="form-group-inline"><div class="inline-item"><label for="edit-direction">H∆∞·ªõng Nh√†:</label><select id="edit-direction"><option value="">Ch·ªçn H∆∞·ªõng</option><option value="ƒê√¥ng">ƒê√¥ng</option><option value="T√¢y">T√¢y</option><option value="Nam">Nam</option><option value="B·∫Øc">B·∫Øc</option><option value="ƒê√¥ng-B·∫Øc">ƒê√¥ng-B·∫Øc</option><option value="ƒê√¥ng-Nam">ƒê√¥ng-Nam</option><option value="T√¢y-B·∫Øc">T√¢y-B·∫Øc</option><option value="T√¢y-Nam">T√¢y-Nam</option></select></div><div class="inline-item"><label for="edit-legal">T√¨nh tr·∫°ng S·ªï:</label><select id="edit-legal"><option value="">Ch·ªçn T√¨nh tr·∫°ng</option><option value="S·ªï H·ªìng">S·ªï H·ªìng</option><option value="S·ªï ƒê·ªè">S·ªï ƒê·ªè</option><option value="H·ª£p ƒê·ªìng Mua B√°n">H·ª£p ƒê·ªìng Mua B√°n</option><option value="Ch∆∞a c√≥ S·ªï">Ch∆∞a c√≥ S·ªï</option></select></div></div>
            <div class="form-group-inline"><div class="inline-item"><label for="edit-bedrooms">S·ªë PN:</label><input type="number" id="edit-bedrooms" min="0" placeholder="PN"></div><div class="inline-item"><label for="edit-wc">S·ªë WC:</label><input type="number" id="edit-wc" min="0" placeholder="WC"></div><div class="inline-item"><label for="edit-floors">S·ªë L·∫ßu:</label><input type="number" id="edit-floors" min="0" placeholder="L·∫ßu"></div></div>
            <div class="form-group-inline"><div class="inline-item"><label for="edit-address">ƒê·ªãa ch·ªâ:</label><input type="text" id="edit-address" placeholder="ƒê·ªãa ch·ªâ"></div><div class="inline-item"><label for="edit-phone">S·ªë ƒëi·ªán tho·∫°i:</label><input type="text" id="edit-phone" placeholder="SƒêT"></div></div>
            <div class="form-group-checkbox"><input type="checkbox" id="edit-loanable"><label for="edit-loanable" style="margin-bottom: 0;">C√≥ th·ªÉ vay th√™m</label></div>
            
            <button type="submit" style="margin-top: 15px; width: 100%; background-color: #007bff;">L∆∞u Th√¥ng Tin C·∫≠p Nh·∫≠t</button>
        </form>
    </div>
</div>

<script>
    // =======================================================
    // 1. C·∫§U H√åNH & KH·ªûI T·∫†O
    // =======================================================
    const firebaseConfig = {
      apiKey: "AIzaSyBBFhxxkIZSguuMV5AZzhLSWa19LYXMOY8",
      authDomain: "bdss-1f754.firebaseapp.com",
      projectId: "bdss-1f754",
      storageBucket: "bdss-1f754.firebasestorage.app",
      messagingSenderId: "1081373432468",
      appId: "1:1081373432468:web:f38cab72330d75de67b281"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();
    const propertiesRef = db.collection('properties'); 

    // C·∫§U H√åNH CLOUDINARY (C·∫¶N CHO CH·ª®C NƒÇNG C·∫¨P NH·∫¨T ·∫¢NH)
    const CLOUDINARY_CLOUD_NAME = 'djngpyafe'; 
    const CLOUDINARY_UPLOAD_PRESET = 'bdstx'; 
    const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

    let properties = []; 
    let newImageFiles = []; 
    let isAdmin = false; 

    const inputLink = document.getElementById('input-link');
    const logoutBtn = document.getElementById('logout-btn');
    const loginLink = document.getElementById('login-link');
    const resultCountSpan = document.getElementById('result-count');


    // =======================================================
    // 2. PH√ÇN QUY·ªÄN V√Ä ƒêƒÇNG XU·∫§T
    // =======================================================
    
    // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p ƒë·ªÉ ph√¢n quy·ªÅn hi·ªÉn th·ªã n√∫t
    auth.onAuthStateChanged(user => {
        isAdmin = !!user; 
        
        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã c√°c n√∫t ch·ª©c nƒÉng
        inputLink.style.display = isAdmin ? 'inline-block' : 'none';
        logoutBtn.style.display = isAdmin ? 'inline-block' : 'none';
        loginLink.style.display = isAdmin ? 'none' : 'inline-block';
        
        searchProperties(); // Render l·∫°i danh s√°ch ƒë·ªÉ hi·ªán/·∫©n n√∫t s·ª≠a/x√≥a
    });

    function logout() {
        auth.signOut().then(() => {
            alert("ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng.");
            window.location.href = 'login.html';
        }).catch(error => {
            console.error("L·ªói ƒëƒÉng xu·∫•t:", error);
            alert("L·ªói khi ƒëƒÉng xu·∫•t. Vui l√≤ng th·ª≠ l·∫°i.");
        });
    }

    // =======================================================
    // 3. LOGIC T·∫¢I V√Ä C·∫¨P NH·∫¨T ·∫¢NH (CLOUDINARY)
    // =======================================================
    
    function previewNewImages(event) {
        const fileInput = event.target;
        newImageFiles = Array.from(fileInput.files);
        const previewContainer = document.getElementById('new-images-preview');
        previewContainer.innerHTML = ''; 

        if (newImageFiles.length === 0) return;

        newImageFiles.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = file.name;
                previewContainer.appendChild(img);
            };
            reader.readAsDataURL(file); 
        });
    }

    document.getElementById('update-image-upload').addEventListener('change', previewNewImages);
    
    // T·∫£i h√¨nh ·∫£nh l√™n Cloudinary
    async function uploadImagesToCloudinary(files) {
        const uploadPromises = [];
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET); 

            const promise = fetch(CLOUDINARY_UPLOAD_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(`Cloudinary upload failed: ${response.statusText} - ${errorData.error.message}`);
                    });
                }
                return response.json();
            })
            .then(data => data.secure_url);
            
            uploadPromises.push(promise);
        }
        return Promise.all(uploadPromises);
    }
    
    // X√≥a ·∫£nh c≈© trong Modal
    async function deleteImage(propertyId, imageUrl) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h√¨nh ·∫£nh n√†y kh√¥ng?')) return;

        const propertyIndex = properties.findIndex(p => p.id === propertyId);
        if (propertyIndex === -1) return;

        try {
            properties[propertyIndex].images = properties[propertyIndex].images.filter(img => img !== imageUrl);
            
            await propertiesRef.doc(propertyId).update({
                images: properties[propertyIndex].images
            });

            openImageModal(propertyId); 
        } catch (error) {
            console.error("L·ªói khi x√≥a ·∫£nh: ", error);
            alert("L·ªói khi x√≥a ·∫£nh. Vui l√≤ng ki·ªÉm tra console.");
        }
    }

    // L∆∞u c·∫≠p nh·∫≠t ·∫£nh (t·ª´ Modal)
    async function saveUpdatedImages() {
        if (!isAdmin) return; // Ch·∫∑n n·∫øu kh√¥ng ph·∫£i Admin

        const propertyId = document.getElementById('current-property-id').value; 
        const propertyIndex = properties.findIndex(p => p.id === propertyId);
        
        if (newImageFiles.length === 0) {
            alert('Kh√¥ng c√≥ ·∫£nh m·ªõi n√†o ƒë∆∞·ª£c ch·ªçn.');
            return;
        }

        try {
            const newImageUrls = await uploadImagesToCloudinary(newImageFiles); 
            
            const currentImages = properties[propertyIndex].images || [];
            const updatedImages = [...currentImages, ...newImageUrls];
            
            await propertiesRef.doc(propertyId).update({
                images: updatedImages
            });
            
            alert('ƒê√£ c·∫≠p nh·∫≠t h√¨nh ·∫£nh th√†nh c√¥ng!');
            closeModal('imageModal');
            newImageFiles = []; 
        } catch (error) {
            console.error("L·ªói khi c·∫≠p nh·∫≠t ·∫£nh l√™n Cloudinary: ", error);
            alert("L·ªói khi c·∫≠p nh·∫≠t ·∫£nh. Vui l√≤ng ki·ªÉm tra console.");
        }
    }


    // =======================================================
    // 4. LOGIC X√ìA & C·∫¨P NH·∫¨T CHI TI·∫æT
    // =======================================================
    
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // M·ªü Modal C·∫≠p nh·∫≠t ·∫¢nh
    function openImageModal(propertyId) {
        if (!isAdmin) return; // Ch·ªâ Admin m·ªõi ƒë∆∞·ª£c m·ªü modal
        const property = properties.find(p => p.id === propertyId);
        if (!property) return;
        
        document.getElementById('current-property-id').value = propertyId;
        document.getElementById('modal-title').textContent = `C·∫≠p nh·∫≠t ·∫£nh cho: ${property.name}`;
        
        const gallery = document.getElementById('modal-gallery');
        gallery.innerHTML = ''; 

        (property.images || []).forEach(url => {
            const wrapper = document.createElement('div');
            wrapper.className = 'image-wrapper';
            wrapper.innerHTML = `
                <img src="${url}" alt="·∫¢nh BƒêS">
                <button class="delete-image-btn" onclick="deleteImage('${propertyId}', '${url}')">X</button>
            `;
            gallery.appendChild(wrapper);
        });
        
        document.getElementById('update-image-upload').value = null;
        document.getElementById('new-images-preview').innerHTML = '';
        newImageFiles = [];

        document.getElementById('imageModal').style.display = 'flex';
    }

    // M·ªü Modal C·∫≠p nh·∫≠t Chi ti·∫øt
    function openDetailsModal(propertyId) {
        if (!isAdmin) return; // Ch·ªâ Admin m·ªõi ƒë∆∞·ª£c m·ªü modal
        const property = properties.find(p => p.id === propertyId);
        if (!property) return;

        document.getElementById('edit-property-id').value = propertyId;
        
        document.getElementById('edit-name').value = property.name !== "Ch∆∞a c·∫≠p nh·∫≠t" ? property.name : '';
        document.getElementById('edit-phone').value = property.phone !== "Ch∆∞a c·∫≠p nh·∫≠t" ? property.phone : '';
        document.getElementById('edit-address').value = property.address !== "Ch∆∞a c·∫≠p nh·∫≠t" ? property.address : '';
        document.getElementById('edit-price').value = property.price !== null ? property.price : '';
        document.getElementById('edit-area').value = property.area !== null ? property.area : '';
        document.getElementById('edit-bedrooms').value = property.bedrooms !== null ? property.bedrooms : '';
        document.getElementById('edit-wc').value = property.wc !== null ? property.wc : '';
        document.getElementById('edit-kitchens').value = property.kitchens !== null ? property.kitchens : '';
        document.getElementById('edit-floors').value = property.floors !== null ? property.floors : '';
        document.getElementById('edit-direction').value = property.direction !== "Ch∆∞a c·∫≠p nh·∫≠t" ? property.direction : '';
        document.getElementById('edit-legal').value = property.legal !== "Ch∆∞a c·∫≠p nh·∫≠t" ? property.legal : '';
        document.getElementById('edit-loanable').checked = property.loanable;
        
        document.getElementById('detailsModal').style.display = 'flex';
    }

    // L∆∞u c·∫≠p nh·∫≠t chi ti·∫øt (UPDATE)
    async function savePropertyDetails() {
        if (!isAdmin) return; // Ch·∫∑n n·∫øu kh√¥ng ph·∫£i Admin

        const propertyId = document.getElementById('edit-property-id').value; 
        
        const updatedData = {
            name: document.getElementById('edit-name').value.trim() || "Ch∆∞a c·∫≠p nh·∫≠t",
            phone: document.getElementById('edit-phone').value.trim() || "Ch∆∞a c·∫≠p nh·∫≠t",
            address: document.getElementById('edit-address').value.trim() || "Ch∆∞a c·∫≠p nh·∫≠t",
            price: parseFloat(document.getElementById('edit-price').value.trim()) || null, 
            area: parseFloat(document.getElementById('edit-area').value.trim()) || null, 
            direction: document.getElementById('edit-direction').value || "Ch∆∞a c·∫≠p nh·∫≠t",
            bedrooms: parseInt(document.getElementById('edit-bedrooms').value.trim()) || null,
            wc: parseInt(document.getElementById('edit-wc').value.trim()) || null,
            kitchens: parseInt(document.getElementById('edit-kitchens').value.trim()) || null,
            floors: parseInt(document.getElementById('edit-floors').value.trim()) || null,
            legal: document.getElementById('edit-legal').value || "Ch∆∞a c·∫≠p nh·∫≠t",
            loanable: document.getElementById('edit-loanable').checked,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await propertiesRef.doc(propertyId).update(updatedData);
            alert('ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin chi ti·∫øt th√†nh c√¥ng!');
            closeModal('detailsModal');
        } catch (error) {
            console.error("L·ªói khi c·∫≠p nh·∫≠t chi ti·∫øt: ", error);
            alert("L·ªói khi c·∫≠p nh·∫≠t chi ti·∫øt. Vui l√≤ng ki·ªÉm tra console.");
        }
    }
    
    // X√ìA B·∫§T ƒê·ªòNG S·∫¢N HO√ÄN TO√ÄN
    function deleteProperty(propertyId) {
        if (!isAdmin) return; // Ch·∫∑n n·∫øu kh√¥ng ph·∫£i Admin
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA Vƒ®NH VI·ªÑN b·∫•t ƒë·ªông s·∫£n n√†y kh√¥ng?')) return;
        
        propertiesRef.doc(propertyId).delete()
            .then(() => alert('ƒê√£ x√≥a b·∫•t ƒë·ªông s·∫£n th√†nh c√¥ng!'))
            .catch(error => {
                console.error("L·ªói khi x√≥a: ", error);
                alert("L·ªói khi x√≥a d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra console.");
            });
    }

    
    // =======================================================
    // 5. LOGIC HI·ªÇN TH·ªä V√Ä T√åM KI·∫æM
    // =======================================================

    function renderProperty(property) {
        const listItem = document.createElement('li');
        listItem.className = 'property-item';
        
        const imagesHtml = (property.images || [])
            .slice(0, 3) 
            .map(url => `<img src="${url}" alt="·∫¢nh BƒêS">`)
            .join('');

        const formatPrice = (p) => p !== null ? `${p.toLocaleString('vi-VN')} t·ª∑ VNƒê` : 'Ch∆∞a c·∫≠p nh·∫≠t';
        const formatArea = (a) => a !== null ? `${a.toLocaleString('vi-VN')} m¬≤` : 'Ch∆∞a c·∫≠p nh·∫≠t';
        
        // Ch·ªâ hi·ªán n√∫t S·ª≠a/X√≥a n·∫øu l√† Admin
        let actionsHtml = '';
        if (isAdmin) {
            actionsHtml = `
                <button class="edit-details-btn" onclick="openDetailsModal('${property.id}')">S·ª≠a TT</button>
                <button class="delete-btn" onclick="deleteProperty('${property.id}')">X√≥a</button>
            `;
        }

        listItem.innerHTML = `
            <div class="property-content" style="flex: 1;">
                <h4 style="margin-top: 0; color: #0056b3;">${property.name} - ${formatPrice(property.price)}</h4>
                <div class="property-details-grid">
                    <span><strong>Di·ªán t√≠ch:</strong> ${formatArea(property.area)}</span>
                    <span><strong>PN/WC/L·∫ßu:</strong> ${property.bedrooms || 0}/${property.wc || 0}/${property.floors || 0}</span>
                    <span><strong>H∆∞·ªõng:</strong> ${property.direction}</span>
                    <span><strong>ƒê·ªãa ch·ªâ:</strong> ${property.address}</span>
                    <span><strong>SƒêT:</strong> ${property.phone}</span>
                    <span><strong>S·ªï:</strong> ${property.legal} (${property.loanable ? 'C√≥ th·ªÉ vay' : 'Kh√¥ng vay ƒë∆∞·ª£c'})</span>
                </div>
            </div>
            
            <div class="property-images" onclick="${isAdmin ? `openImageModal('${property.id}')` : `alert('ƒêƒÉng nh·∫≠p Admin ƒë·ªÉ xem ·∫£nh chi ti·∫øt')`}" title="${isAdmin ? 'B·∫•m ƒë·ªÉ xem & c·∫≠p nh·∫≠t ·∫£nh' : 'B·∫•m ƒë·ªÉ xem ·∫£nh chi ti·∫øt'}">
                ${imagesHtml}
                ${(property.images && property.images.length > 3) ? `+${property.images.length - 3}` : ''}
            </div>

            <div class="property-actions">
                ${actionsHtml}
            </div>
        `;
        document.getElementById('results-list').appendChild(listItem);
    }
    
    // H√†m t√¨m ki·∫øm v√† l·ªçc
    function searchProperties() {
        const filterName = document.getElementById('filter-name').value.toLowerCase();
        const filterPhone = document.getElementById('filter-phone').value.toLowerCase();
        const filterAddress = document.getElementById('filter-address').value.toLowerCase();
        const filterPriceMin = parseFloat(document.getElementById('filter-price-min').value) || 0;
        const filterPriceMax = parseFloat(document.getElementById('filter-price-max').value) || Infinity;
        const filterAreaMin = parseFloat(document.getElementById('filter-area-min').value) || 0;
        const filterDirection = document.getElementById('filter-direction').value;
        const filterLegal = document.getElementById('filter-legal').value;
        const filterLoanable = document.getElementById('filter-loanable').checked;
        const filterBedroomsMin = parseInt(document.getElementById('filter-bedrooms-min').value) || 0;
        const filterWcMin = parseInt(document.getElementById('filter-wc-min').value) || 0;
        const filterFloorsMin = parseInt(document.getElementById('filter-floors-min').value) || 0;

        const filteredProperties = properties.filter(p => {
            const price = p.price || 0;
            const area = p.area || 0;
            const bedrooms = p.bedrooms || 0;
            const wc = p.wc || 0;
            const floors = p.floors || 0;

            if (filterName && !p.name.toLowerCase().includes(filterName)) return false;
            if (filterPhone && !p.phone.toLowerCase().includes(filterPhone)) return false;
            if (filterAddress && !p.address.toLowerCase().includes(filterAddress)) return false;

            if (price < filterPriceMin || price > filterPriceMax) return false;
            if (area < filterAreaMin) return false;

            if (filterDirection && p.direction !== filterDirection) return false;
            if (filterLegal && p.legal !== filterLegal) return false;
            if (filterLoanable && !p.loanable) return false;

            if (bedrooms < filterBedroomsMin) return false;
            if (wc < filterWcMin) return false;
            if (floors < filterFloorsMin) return false;

            return true;
        });

        const resultsList = document.getElementById('results-list');
        resultsList.innerHTML = '';
        resultCountSpan.textContent = filteredProperties.length;

        if (filteredProperties.length === 0) {
            resultsList.innerHTML = '<li style="list-style: none; color: #dc3545;">Kh√¥ng t√¨m th·∫•y b·∫•t ƒë·ªông s·∫£n n√†o ph√π h·ª£p.</li>';
        } else {
            filteredProperties.forEach(renderProperty);
        }
    }

    // L·∫Øng nghe thay ƒë·ªïi t·ª´ Firestore
    propertiesRef.orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        properties = [];
        snapshot.docs.forEach(doc => {
            properties.push({ id: doc.id, ...doc.data() });
        });
        searchProperties(); 
    }, error => {
        console.error("L·ªói khi l·∫Øng nghe Firestore (Ki·ªÉm tra Rules): ", error); 
        document.getElementById('results-list').innerHTML = '<li style="list-style: none; color: red;">L·ªñI: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra Firebase Security Rules.</li>';
    });
</script>

</body>
</html>
