<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nháº­p ThÃ´ng Tin Báº¥t Äá»™ng Sáº£n</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <style>
        /* CSS CÆ  Báº¢N */
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 800px; margin: auto; }
        .column { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group input[type="file"], .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-group-inline { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group-inline .inline-item { flex: 1; }
        .form-group-checkbox { display: flex; align-items: center; gap: 10px; height: 40px; margin-top: 25px; }
        .action-buttons button { background-color: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; min-width: 80px; }
        .action-buttons button:hover { background-color: #218838; }
        #preview-area-images { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        #preview-area-images img { max-width: 100px; height: auto; border: 1px solid #ddd; border-radius: 4px; }
        .action-link { text-decoration: none; padding: 10px 15px; border-radius: 4px; font-size: 16px; margin-left: 10px; float: right;}
    </style>
</head>
<body>

<div class="container">
    <div class="column">
        <div style="margin-bottom: 20px;">
            <a href="search.html" class="action-link" style="background-color: #007bff; color: white;">
                ğŸ” Xem Danh SÃ¡ch & TÃ¬m Kiáº¿m
            </a>
            <a href="#" onclick="logout()" class="action-link" id="logout-btn" style="background-color: #dc3545; color: white;">
                ÄÄƒng Xuáº¥t
            </a>
        </div>

        <h2>â• Nháº­p ThÃ´ng Tin Báº¥t Äá»™ng Sáº£n</h2>
        <form id="property-form">
            <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="name">TÃªn / TiÃªu Ä‘á»:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="name" placeholder="VÃ­ dá»¥: CÄƒn há»™ cao cáº¥p Quáº­n 1">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="phone">Sá»‘ Ä‘iá»‡n thoáº¡i:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="phone" placeholder="090...">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="address">Äá»‹a chá»‰:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="address" placeholder="123 ÄÆ°á»ng ABC, PhÆ°á»ng X, Quáº­n Y">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="form-group-inline">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inline-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="price">GiÃ¡ (VNÄ/tá»·):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="price" step="0.01" placeholder="VÃ­ dá»¥: 3.5 (tá»·)">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inline-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="area">Diá»‡n tÃ­ch (mÂ²):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="area" step="0.1" placeholder="VÃ­ dá»¥: 80.5">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="direction">HÆ°á»›ng NhÃ :</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="direction">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Chá»n HÆ°á»›ng</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="ÄÃ´ng">ÄÃ´ng</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="TÃ¢y">TÃ¢y</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Nam">Nam</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Báº¯c">Báº¯c</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="ÄÃ´ng-Báº¯c">ÄÃ´ng-Báº¯c</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="ÄÃ´ng-Nam">ÄÃ´ng-Nam</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="TÃ¢y-Báº¯c">TÃ¢y-Báº¯c</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="TÃ¢y-Nam">TÃ¢y-Nam</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="form-group-inline">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inline-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="bedrooms">Sá»‘ PN:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="bedrooms" min="0" placeholder="PhÃ²ng ngá»§">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inline-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="wc">Sá»‘ WC:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="wc" min="0" placeholder="PhÃ²ng WC">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inline-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="kitchens">Sá»‘ Báº¿p:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="kitchens" min="0" placeholder="Báº¿p">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inline-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="floors">Sá»‘ Láº§u:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="floors" min="0" placeholder="Sá»‘ táº§ng">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="form-group-inline">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inline-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="legal">TÃ¬nh tráº¡ng Sá»•:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="legal">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Chá»n TÃ¬nh tráº¡ng</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Sá»• Há»“ng">Sá»• Há»“ng</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Sá»• Äá»">Sá»• Äá»</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Há»£p Äá»“ng Mua BÃ¡n">Há»£p Äá»“ng Mua BÃ¡n</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="ChÆ°a cÃ³ Sá»•">ChÆ°a cÃ³ Sá»•</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="inline-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group-checkbox">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="loanable">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="loanable" style="margin-bottom: 0;">CÃ³ thá»ƒ vay thÃªm</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="image-upload">HÃ¬nh áº£nh (CÃ³ thá»ƒ chá»n nhiá»u):</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="image-upload" accept="image/*" multiple required>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="form-group" id="preview-area">
Â  Â  Â  Â  Â  Â  Â  Â  <label>Xem trÆ°á»›c áº£nh Ä‘Ã£ chá»n:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="preview-area-images"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
            <div class="action-buttons">
                <button type="submit">LÆ°u ThÃ´ng Tin</button>
            </div>
        </form>
        <p style="margin-top: 15px; font-size: 0.9em; color: #6c757d;">*Dá»¯ liá»‡u Ä‘Æ°á»£c lÆ°u trá»¯ trÃªn Cloud Firestore.</p>
    </div>
</div>

<script>
    // =======================================================
    // 1. Cáº¤U HÃŒNH & KHá»I Táº O
    // =======================================================

    const firebaseConfig = {
      apiKey: "AIzaSyBBFhxxkIZSguuMV5AZzhLSWa19LYXMOY8",
      authDomain: "bdss-1f754.firebaseapp.com",
      projectId: "bdss-1f754",
      storageBucket: "bdss-1f754.firebasestorage.app",
      messagingSenderId: "1081373432468",
      appId: "1:1081373432468:web:f38cab72330d75de67b281"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();
    const propertiesRef = db.collection('properties'); 

    // Cáº¤U HÃŒNH CLOUDINARY (ÄÃƒ Sá»¬A Lá»–I URL VÃ€ Báº¢O Máº¬T)
    const CLOUDINARY_CLOUD_NAME = 'djngpyafe'; 
    const CLOUDINARY_UPLOAD_PRESET = 'bdstx'; 
    const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
    
    // =======================================================
    // 2. PHÃ‚N QUYá»€N VÃ€ ÄÄ‚NG XUáº¤T
    // =======================================================
    
    // Báº¯t buá»™c pháº£i Ä‘Äƒng nháº­p (Admin)
    auth.onAuthStateChanged(user => {
        if (!user) {
            alert("Báº¡n cáº§n Ä‘Äƒng nháº­p vá»›i quyá»n Admin Ä‘á»ƒ thá»±c hiá»‡n chá»©c nÄƒng nÃ y.");
            window.location.href = 'login.html'; 
        }
    });

    function logout() {
        auth.signOut().then(() => {
            alert("ÄÃ£ Ä‘Äƒng xuáº¥t thÃ nh cÃ´ng.");
            window.location.href = 'login.html'; 
        }).catch(error => {
            console.error("Lá»—i Ä‘Äƒng xuáº¥t:", error);
            alert("Lá»—i khi Ä‘Äƒng xuáº¥t. Vui lÃ²ng thá»­ láº¡i.");
        });
    }

    // =======================================================
    // 3. LOGIC Táº¢I áº¢NH (CLOUDINARY)
    // =======================================================
    
    function previewImages() {
        const fileInput = document.getElementById('image-upload');
        const previewContainer = document.getElementById('preview-area-images');
        previewContainer.innerHTML = ''; 
        const files = Array.from(fileInput.files);

        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = file.name;
                previewContainer.appendChild(img);
            };
            reader.readAsDataURL(file); 
        });
    }

    document.getElementById('image-upload').addEventListener('change', previewImages);

    // Táº£i hÃ¬nh áº£nh lÃªn Cloudinary
    async function uploadImagesToCloudinary(files) {
        const uploadPromises = [];

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET); 

            const promise = fetch(CLOUDINARY_UPLOAD_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(`Cloudinary upload failed: ${response.statusText} - ${errorData.error.message}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                return data.secure_url; 
            });
            
            uploadPromises.push(promise);
        }

        return Promise.all(uploadPromises);
    }
    

    // =======================================================
    // 4. LOGIC LÆ¯U Dá»® LIá»†U (CREATE)
    // =======================================================

    async function propertyFormSubmit(e) {
        e.preventDefault();
        
        const name = document.getElementById('name').value.trim() || "ChÆ°a cáº­p nháº­t";
        const phone = document.getElementById('phone').value.trim() || "ChÆ°a cáº­p nháº­t";
        const address = document.getElementById('address').value.trim() || "ChÆ°a cáº­p nháº­t";
        const priceValue = document.getElementById('price').value.trim();
        const price = priceValue ? parseFloat(priceValue) : null; 
        const areaValue = document.getElementById('area').value.trim();
        const area = areaValue ? parseFloat(areaValue) : null; 
        const direction = document.getElementById('direction').value || "ChÆ°a cáº­p nháº­t";
        const bedroomsValue = document.getElementById('bedrooms').value.trim();
        const bedrooms = bedroomsValue ? parseInt(bedroomsValue) : null;
        const wcValue = document.getElementById('wc').value.trim();
        const wc = wcValue ? parseInt(wcValue) : null;
        const kitchensValue = document.getElementById('kitchens').value.trim();
        const kitchens = kitchensValue ? parseInt(kitchensValue) : null;
        const floorsValue = document.getElementById('floors').value.trim();
        const floors = floorsValue ? parseInt(floorsValue) : null;
        const legal = document.getElementById('legal').value || "ChÆ°a cáº­p nháº­t";
        const loanable = document.getElementById('loanable').checked;

        const imageFiles = document.getElementById('image-upload').files; 

        if (imageFiles.length === 0) {
            alert('Vui lÃ²ng chá»n Ã­t nháº¥t má»™t hÃ¬nh áº£nh.');
            return;
        }

        try {
            // Táº¢I áº¢NH LÃŠN CLOUDINARY
            const imageUrls = await uploadImagesToCloudinary(imageFiles); 
            
            const newProperty = {
                name, phone, address, price, area, direction, bedrooms, wc, kitchens, floors, legal, loanable,
                images: imageUrls, 
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            await propertiesRef.add(newProperty);

            alert('ÄÃ£ lÆ°u thÃ´ng tin báº¥t Ä‘á»™ng sáº£n thÃ nh cÃ´ng!');
            document.getElementById('property-form').reset();
            document.getElementById('preview-area-images').innerHTML = ''; 
        } catch (error) {
            console.error("Lá»—i khi lÆ°u dá»¯ liá»‡u hoáº·c táº£i áº£nh lÃªn Cloudinary: ", error);
            alert("Lá»—i khi lÆ°u dá»¯ liá»‡u. Vui lÃ²ng kiá»ƒm tra console vÃ  cáº¥u hÃ¬nh Cloudinary.");
        }
    }

    document.getElementById('property-form').addEventListener('submit', propertyFormSubmit);

</script>

</body>
</html>
