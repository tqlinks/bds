<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Web Qu·∫£n L√Ω BƒêS (Cloud Storage & Firestore)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script> 

    <style>
        /* CSS code remains the same as previous response, including styles for modals, forms, and lists */
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; color: #333; }
        .container { display: flex; gap: 20px; max-width: 1200px; margin: auto; }
        .column { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .column-left { flex: 1.5; }
        .column-right { flex: 2; }
        h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group input[type="file"], .form-group select, .filter-item input[type="text"], .filter-item input[type="number"], .filter-item select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-group-inline, .filter-group { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group-inline .inline-item, .filter-group .filter-item { flex: 1; }
        .form-group-checkbox { display: flex; align-items: center; gap: 10px; height: 40px; margin-top: 25px; }
        .form-group-checkbox input[type="checkbox"] { width: 20px; height: 20px; margin: 0; padding: 0; border: 1px solid #ccc; }
        .filter-item-checkbox { align-self: flex-end; padding-bottom: 5px; }
        button { background-color: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; min-width: 80px; }
        button:hover { background-color: #218838; }
        .delete-btn { background-color: #dc3545; padding: 5px 10px; font-size: 14px; }
        .delete-btn:hover { background-color: #c82333; }
        .update-img-btn { background-color: #007bff; padding: 5px 10px; font-size: 14px; }
        .update-img-btn:hover { background-color: #0056b3; }
        .edit-details-btn { background-color: #ffc107; color: #333; padding: 5px 10px; font-size: 14px; }
        .edit-details-btn:hover { background-color: #e0a800; }
        .property-item { border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; padding: 15px; display: flex; gap: 15px; align-items: flex-start; background-color: #fafafa; position: relative; }
        .property-actions { position: absolute; top: 10px; right: 10px; display: flex; flex-direction: column; gap: 5px; }
        .property-images { display: flex; gap: 5px; flex-wrap: wrap; max-width: 150px; cursor: pointer; border: 1px solid #ccc; padding: 5px; border-radius: 4px; margin-top: 5px; }
        .property-images img { max-width: 100%; height: 70px; width: auto; border-radius: 4px; object-fit: cover; }
        .property-details-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px 10px; margin-top: 10px; font-size: 0.9em; }
        #preview-area-images { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        #preview-area-images img { max-width: 100px; height: auto; border: 1px solid #ddd; border-radius: 4px; }
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; padding: 20px; border-radius: 8px; width: 90%; max-width: 900px; position: relative; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); max-height: 90vh; overflow-y: auto; }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; top: 10px; right: 20px; z-index: 1001; background: rgba(255, 255, 255, 0.5); border-radius: 50%; padding: 0 8px; }
        .modal-close:hover, .modal-close:focus { color: #ff0000; }
        #modal-gallery { border: 1px solid #ddd; padding: 10px; border-radius: 4px; background-color: #fff; margin-bottom: 20px; }
        .current-images-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
        .image-wrapper { position: relative; overflow: hidden; border-radius: 4px; }
        .image-wrapper img { width: 100%; height: 120px; object-fit: cover; display: block; }
        .delete-image-btn { position: absolute; top: 5px; right: 5px; background: rgba(255, 0, 0, 0.8); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px; line-height: 1; text-align: center; padding: 0; }
        .new-images-preview { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .new-images-preview img { max-width: 80px; height: 80px; object-fit: cover; border: 1px solid #007bff; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">

    <div class="column column-left">
        <h2>‚ûï Nh·∫≠p Th√¥ng Tin B·∫•t ƒê·ªông S·∫£n</h2>
        <form id="property-form">
            <div class="form-group">
                <label for="name">T√™n / Ti√™u ƒë·ªÅ:</label>
                <input type="text" id="name" placeholder="V√≠ d·ª•: CƒÉn h·ªô cao c·∫•p Qu·∫≠n 1">
            </div>
            <div class="form-group">
                <label for="phone">S·ªë ƒëi·ªán tho·∫°i:</label>
                <input type="text" id="phone" placeholder="090...">
            </div>
            <div class="form-group">
                <label for="address">ƒê·ªãa ch·ªâ:</label>
                <input type="text" id="address" placeholder="123 ƒê∆∞·ªùng ABC, Ph∆∞·ªùng X, Qu·∫≠n Y">
            </div>
            
            <div class="form-group-inline">
                <div class="inline-item">
                    <label for="price">Gi√° (VNƒê/t·ª∑):</label>
                    <input type="number" id="price" step="0.01" placeholder="V√≠ d·ª•: 3.5 (t·ª∑)">
                </div>
                <div class="inline-item">
                    <label for="area">Di·ªán t√≠ch (m¬≤):</label>
                    <input type="number" id="area" step="0.1" placeholder="V√≠ d·ª•: 80.5">
                </div>
            </div>

            <div class="form-group">
                <label for="direction">H∆∞·ªõng Nh√†:</label>
                <select id="direction">
                    <option value="">Ch·ªçn H∆∞·ªõng</option>
                    <option value="ƒê√¥ng">ƒê√¥ng</option>
                    <option value="T√¢y">T√¢y</option>
                    <option value="Nam">Nam</option>
                    <option value="B·∫Øc">B·∫Øc</option>
                    <option value="ƒê√¥ng-B·∫Øc">ƒê√¥ng-B·∫Øc</option>
                    <option value="ƒê√¥ng-Nam">ƒê√¥ng-Nam</option>
                    <option value="T√¢y-B·∫Øc">T√¢y-B·∫Øc</option>
                    <option value="T√¢y-Nam">T√¢y-Nam</option>
                    <option value="C·∫≠p nh·∫≠t">C·∫≠p nh·∫≠t</option>
                </select>
            </div>
            
            <div class="form-group-inline">
                <div class="inline-item">
                    <label for="bedrooms">S·ªë PN:</label>
                    <input type="number" id="bedrooms" min="0" placeholder="Ph√≤ng ng·ªß">
                </div>
                <div class="inline-item">
                    <label for="wc">S·ªë WC:</label>
                    <input type="number" id="wc" min="0" placeholder="Ph√≤ng WC">
                </div>
                <div class="inline-item">
                    <label for="kitchens">S·ªë B·∫øp:</label>
                    <input type="number" id="kitchens" min="0" placeholder="B·∫øp">
                </div>
                <div class="inline-item">
                    <label for="floors">S·ªë L·∫ßu:</label>
                    <input type="number" id="floors" min="0" placeholder="S·ªë t·∫ßng">
                </div>
            </div>

            <div class="form-group-inline">
                <div class="inline-item">
                    <label for="legal">T√¨nh tr·∫°ng S·ªï:</label>
                    <select id="legal">
                        <option value="">Ch·ªçn T√¨nh tr·∫°ng</option>
                        <option value="S·ªï H·ªìng">S·ªï H·ªìng</option>
                        <option value="S·ªï ƒê·ªè">S·ªï ƒê·ªè</option>
                        <option value="H·ª£p ƒê·ªìng Mua B√°n">H·ª£p ƒê·ªìng Mua B√°n</option>
                        <option value="Ch∆∞a c√≥ S·ªï">Ch∆∞a c√≥ S·ªï</option>
                    </select>
                </div>
                <div class="inline-item">
                    <div class="form-group-checkbox">
                        <input type="checkbox" id="loanable">
                        <label for="loanable" style="margin-bottom: 0;">C√≥ th·ªÉ vay th√™m</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="image-upload">H√¨nh ·∫£nh (C√≥ th·ªÉ ch·ªçn nhi·ªÅu):</label>
                <input type="file" id="image-upload" accept="image/*" multiple required>
            </div>
            
            <div class="form-group" id="preview-area">
                <label>Xem tr∆∞·ªõc ·∫£nh ƒë√£ ch·ªçn:</label>
                <div id="preview-area-images"></div>
            </div>
            
            <button type="submit">L∆∞u Th√¥ng Tin</button>
        </form>
        <p style="margin-top: 15px; font-size: 0.9em; color: #6c757d;">*D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr·ªØ tr√™n Cloud Firestore.</p>
    </div>

    <div class="column column-right">
        <h2>üîç T√¨m Ki·∫øm Chi Ti·∫øt</h2>
        <div class="filter-group">
            <div class="filter-item">
                <label for="filter-name">T√™n / Ti√™u ƒë·ªÅ:</label>
                <input type="text" id="filter-name" placeholder="T√¨m ki·∫øm theo T√™n..." onkeyup="searchProperties()">
            </div>
            <div class="filter-item">
                <label for="filter-phone">S·ªë ƒëi·ªán tho·∫°i:</label>
                <input type="text" id="filter-phone" placeholder="T√¨m ki·∫øm theo SƒêT..." onkeyup="searchProperties()">
            </div>
            <div class="filter-item">
                <label for="filter-address">ƒê·ªãa ch·ªâ:</label>
                <input type="text" id="filter-address" placeholder="T√¨m ki·∫øm theo ƒê·ªãa ch·ªâ..." onkeyup="searchProperties()">
            </div>
        </div>
        
        <div class="filter-group">
            <div class="filter-item">
                <label for="filter-price-min">Gi√° min (t·ª∑ VNƒê):</label>
                <input type="number" id="filter-price-min" step="0.01" placeholder="Min Gi√°..." onkeyup="searchProperties()">
            </div>
            <div class="filter-item">
                <label for="filter-price-max">Gi√° max (t·ª∑ VNƒê):</label>
                <input type="number" id="filter-price-max" step="0.01" placeholder="Max Gi√°..." onkeyup="searchProperties()">
            </div>
            <div class="filter-item">
                <label for="filter-area-min">Di·ªán t√≠ch min (m¬≤):</label>
                <input type="number" id="filter-area-min" step="0.1" placeholder="Min Di·ªán t√≠ch..." onkeyup="searchProperties()">
            </div>
        </div>

        <div class="filter-group">
            <div class="filter-item">
                <label for="filter-direction">H∆∞·ªõng Nh√†:</label>
                <select id="filter-direction" onchange="searchProperties()">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="ƒê√¥ng">ƒê√¥ng</option>
                    <option value="T√¢y">T√¢y</option>
                    <option value="Nam">Nam</option>
                    <option value="B·∫Øc">B·∫Øc</option>
                    <option value="ƒê√¥ng-B·∫Øc">ƒê√¥ng-B·∫Øc</option>
                    <option value="ƒê√¥ng-Nam">ƒê√¥ng-Nam</option>
                    <option value="T√¢y-B·∫Øc">T√¢y-B·∫Øc</option>
                    <option value="T√¢y-Nam">T√¢y-Nam</option>
                </select>
            </div>
            <div class="filter-item">
                <label for="filter-legal">T√¨nh tr·∫°ng S·ªï:</label>
                <select id="filter-legal" onchange="searchProperties()">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="S·ªï H·ªìng">S·ªï H·ªìng</option>
                    <option value="S·ªï ƒê·ªè">S·ªï ƒê·ªè</option>
                    <option value="H·ª£p ƒê·ªìng Mua B√°n">H·ª£p ƒê·ªìng Mua B√°n</option>
                    <option value="Ch∆∞a c√≥ S·ªï">Ch∆∞a c√≥ S·ªï</option>
                </select>
            </div>
            <div class="filter-item filter-item-checkbox">
                <div class="form-group-checkbox">
                    <input type="checkbox" id="filter-loanable" onchange="searchProperties()">
                    <label for="filter-loanable">Ch·ªâ hi·ªán BƒêS c√≥ th·ªÉ vay</label>
                </div>
            </div>
        </div>

        <div class="filter-group">
            <div class="filter-item">
                <label for="filter-bedrooms-min">PN t·ªëi thi·ªÉu:</label>
                <input type="number" id="filter-bedrooms-min" min="0" placeholder="Min PN" onkeyup="searchProperties()">
            </div>
            <div class="filter-item">
                <label for="filter-wc-min">WC t·ªëi thi·ªÉu:</label>
                <input type="number" id="filter-wc-min" min="0" placeholder="Min WC" onkeyup="searchProperties()">
            </div>
            <div class="filter-item">
                <label for="filter-floors-min">L·∫ßu t·ªëi thi·ªÉu:</label>
                <input type="number" id="filter-floors-min" min="0" placeholder="Min L·∫ßu" onkeyup="searchProperties()">
            </div>
        </div>
        
        <h3>Danh s√°ch K·∫øt qu·∫£</h3>
        <ul id="results-list">
        </ul>
    </div>

</div>

<div id="imageModal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('imageModal')">&times;</span>
        <h3 id="modal-title"></h3>
        
        <input type="hidden" id="current-property-id">

        <h4>·∫¢nh Hi·ªán T·∫°i (B·∫•m X ƒë·ªÉ x√≥a)</h4>
        <div id="modal-gallery" class="current-images-grid">
            </div>

        <h4 style="margin-top: 20px;">Th√™m ·∫¢nh M·ªõi</h4>
        <div class="form-group-inline">
            <div class="inline-item">
                <input type="file" id="update-image-upload" accept="image/*" multiple>
            </div>
        </div>
        
        <div class="new-images-preview" id="new-images-preview">
             </div>

        <button onclick="saveUpdatedImages()" style="margin-top: 15px; width: 100%;">L∆∞u C·∫≠p Nh·∫≠t ·∫¢nh</button>
    </div>
</div>

<div id="detailsModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
        <span class="modal-close" onclick="closeModal('detailsModal')">&times;</span>
        <h3 style="color: #ffc107;">‚úèÔ∏è S·ª≠a Th√¥ng Tin Chi Ti·∫øt</h3>
        
        <input type="hidden" id="edit-property-id">

        <form onsubmit="event.preventDefault(); savePropertyDetails();">
            <div class="form-group">
                <label for="edit-name">T√™n / Ti√™u ƒë·ªÅ:</label>
                <input type="text" id="edit-name" placeholder="Ti√™u ƒë·ªÅ">
            </div>
            <div class="form-group-inline">
                <div class="inline-item">
                    <label for="edit-price">Gi√° (t·ª∑):</label>
                    <input type="number" id="edit-price" step="0.01" placeholder="Gi√°">
                </div>
                <div class="inline-item">
                    <label for="edit-area">Di·ªán t√≠ch (m¬≤):</label>
                    <input type="number" id="edit-area" step="0.1" placeholder="Di·ªán t√≠ch">
                </div>
            </div>
            <div class="form-group-inline">
                <div class="inline-item">
                    <label for="edit-direction">H∆∞·ªõng Nh√†:</label>
                    <select id="edit-direction">
                        <option value="">Ch·ªçn H∆∞·ªõng</option>
                        <option value="ƒê√¥ng">ƒê√¥ng</option>
                        <option value="T√¢y">T√¢y</option>
                        <option value="Nam">Nam</option>
                        <option value="B·∫Øc">B·∫Øc</option>
                        <option value="ƒê√¥ng-B·∫Øc">ƒê√¥ng-B·∫Øc</option>
                        <option value="ƒê√¥ng-Nam">ƒê√¥ng-Nam</option>
                        <option value="T√¢y-B·∫Øc">T√¢y-B·∫Øc</option>
                        <option value="T√¢y-Nam">T√¢y-Nam</option>
                    </select>
                </div>
                <div class="inline-item">
                    <label for="edit-legal">T√¨nh tr·∫°ng S·ªï:</label>
                    <select id="edit-legal">
                        <option value="">Ch·ªçn T√¨nh tr·∫°ng</option>
                        <option value="S·ªï H·ªìng">S·ªï H·ªìng</option>
                        <option value="S·ªï ƒê·ªè">S·ªï ƒê·ªè</option>
                        <option value="H·ª£p ƒê·ªìng Mua B√°n">H·ª£p ƒê·ªìng Mua B√°n</option>
                        <option value="Ch∆∞a c√≥ S·ªï">Ch∆∞a c√≥ S·ªï</option>
                    </select>
                </div>
            </div>
            <div class="form-group-inline">
                <div class="inline-item">
                    <label for="edit-bedrooms">S·ªë PN:</label>
                    <input type="number" id="edit-bedrooms" min="0" placeholder="PN">
                </div>
                <div class="inline-item">
                    <label for="edit-wc">S·ªë WC:</label>
                    <input type="number" id="edit-wc" min="0" placeholder="WC">
                </div>
                <div class="inline-item">
                    <label for="edit-floors">S·ªë L·∫ßu:</label>
                    <input type="number" id="edit-floors" min="0" placeholder="L·∫ßu">
                </div>
            </div>
            <div class="form-group-inline">
                 <div class="inline-item">
                    <label for="edit-address">ƒê·ªãa ch·ªâ:</label>
                    <input type="text" id="edit-address" placeholder="ƒê·ªãa ch·ªâ">
                </div>
                <div class="inline-item">
                    <label for="edit-phone">S·ªë ƒëi·ªán tho·∫°i:</label>
                    <input type="text" id="edit-phone" placeholder="SƒêT">
                </div>
            </div>
            <div class="form-group-checkbox">
                <input type="checkbox" id="edit-loanable">
                <label for="edit-loanable" style="margin-bottom: 0;">C√≥ th·ªÉ vay th√™m</label>
            </div>
            
            <button type="submit" style="margin-top: 15px; width: 100%; background-color: #007bff;">L∆∞u Th√¥ng Tin C·∫≠p Nh·∫≠t</button>
        </form>
    </div>
</div>

<script>
    // =======================================================
    // 1. KH·ªûI T·∫†O FIREBASE & C√ÅC THAM CHI·∫æU
    // =======================================================

    // THAY TH·∫æ CONFIG N√ÄY B·∫∞NG C·∫§U H√åNH TH·ª∞C T·∫æ C·ª¶A D·ª∞ √ÅN FIREBASE C·ª¶A B·∫†N
    const firebaseConfig = {
  apiKey: "AIzaSyBBFhxxkIZSguuMV5AZzhLSWa19LYXMOY8",
  authDomain: "bdss-1f754.firebaseapp.com",
  projectId: "bdss-1f754",
  storageBucket: "bdss-1f754.firebasestorage.app",
  messagingSenderId: "1081373432468",
  appId: "1:1081373432468:web:f38cab72330d75de67b281"
};

    firebase.initializeApp(firebaseConfig);

    const db = firebase.firestore();
    const propertiesRef = db.collection('properties'); 
    // THAM CHI·∫æU STORAGE M·ªöI
    const storageRef = firebase.storage().ref();

    let properties = []; 
    let newImageFiles = []; // D√πng File object thay v√¨ Base64 cho vi·ªác upload

    // =======================================================
    // 2. LOGIC XEM TR∆Ø·ªöC & N·ªòP D·ªÆ LI·ªÜU (CREATE)
    // =======================================================
    
    // H√†m xem tr∆∞·ªõc ·∫£nh (gi·ªØ l·∫°i ƒë·ªÉ ng∆∞·ªùi d√πng xem ·∫£nh ƒë√£ ch·ªçn)
    function previewImages() {
        // ... (Logic xem tr∆∞·ªõc ·∫£nh form t·∫°o m·ªõi)
    }

    // H√†m x·ª≠ l√Ω khi ch·ªçn ·∫£nh m·ªõi trong Modal
    function previewNewImages(event) {
        const fileInput = event.target;
        // L∆ØU C√ÅC FILE OBJECT V√ÄO newImageFiles
        newImageFiles = Array.from(fileInput.files);
        const previewContainer = document.getElementById('new-images-preview');
        previewContainer.innerHTML = ''; 

        if (newImageFiles.length === 0) return;

        newImageFiles.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = file.name;
                previewContainer.appendChild(img);
            };
            // V·∫´n d√πng readAsDataURL ƒë·ªÉ hi·ªÉn th·ªã xem tr∆∞·ªõc
            reader.readAsDataURL(file); 
        });
    }
    
    document.getElementById('image-upload').addEventListener('change', previewImages);
    document.getElementById('update-image-upload').addEventListener('change', previewNewImages);


    // X·ª≠ l√Ω Form n·ªôp d·ªØ li·ªáu (CREATE - ƒê√É C·∫¨P NH·∫¨T LOGIC L∆ØU ·∫¢NH)
    async function propertyFormSubmit(e) {
        e.preventDefault();
        
        // ... (Logic chu·∫©n h√≥a d·ªØ li·ªáu form) ...
        const name = document.getElementById('name').value.trim() || "Ch∆∞a c·∫≠p nh·∫≠t";
        const phone = document.getElementById('phone').value.trim() || "Ch∆∞a c·∫≠p nh·∫≠t";
        const address = document.getElementById('address').value.trim() || "Ch∆∞a c·∫≠p nh·∫≠t";
        const priceValue = document.getElementById('price').value.trim();
        const price = priceValue ? parseFloat(priceValue) : null; 
        const areaValue = document.getElementById('area').value.trim();
        const area = areaValue ? parseFloat(areaValue) : null; 
        const direction = document.getElementById('direction').value || "Ch∆∞a c·∫≠p nh·∫≠t";
        const bedroomsValue = document.getElementById('bedrooms').value.trim();
        const bedrooms = bedroomsValue ? parseInt(bedroomsValue) : null;
        const wcValue = document.getElementById('wc').value.trim();
        const wc = wcValue ? parseInt(wcValue) : null;
        const kitchensValue = document.getElementById('kitchens').value.trim();
        const kitchens = kitchensValue ? parseInt(kitchensValue) : null;
        const floorsValue = document.getElementById('floors').value.trim();
        const floors = floorsValue ? parseInt(floorsValue) : null;
        const legal = document.getElementById('legal').value || "Ch∆∞a c·∫≠p nh·∫≠t";
        const loanable = document.getElementById('loanable').checked;

        const imageFiles = document.getElementById('image-upload').files; 

        if (imageFiles.length === 0) {
            alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h√¨nh ·∫£nh.');
            return;
        }

        try {
            const imageUrls = await uploadImagesToStorage(imageFiles); // H√†m t·∫£i ·∫£nh
            
            const newProperty = {
                name, phone, address, price, area, direction, bedrooms, wc, kitchens, floors, legal, loanable,
                images: imageUrls, // CH·ªà L∆ØU URL V√ÄO FIRESTORE
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            await propertiesRef.add(newProperty);

            alert('ƒê√£ l∆∞u th√¥ng tin b·∫•t ƒë·ªông s·∫£n th√†nh c√¥ng!');
            document.getElementById('property-form').reset();
            document.getElementById('preview-area-images').innerHTML = ''; 
        } catch (error) {
            console.error("L·ªói khi l∆∞u d·ªØ li·ªáu ho·∫∑c t·∫£i ·∫£nh: ", error);
            alert("L·ªói khi l∆∞u d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra console.");
        }
    }

    document.getElementById('property-form').addEventListener('submit', propertyFormSubmit);

    // H√ÄM M·ªöI: T·∫£i h√¨nh ·∫£nh l√™n Firebase Storage
    async function uploadImagesToStorage(files, propertyId = null) {
        const uploadPromises = [];
        const folderName = propertyId || 'temp_' + Date.now(); // T·∫°o folder t·∫°m n·∫øu l√† t·∫°o m·ªõi

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const imageName = `${Date.now()}_${file.name}`;
            const imageRef = storageRef.child(`properties/${folderName}/${imageName}`);
            
            const uploadTask = imageRef.put(file);
            
            // Ch·ªù t·∫£i l√™n v√† l·∫•y URL
            const promise = new Promise((resolve, reject) => {
                uploadTask.on(
                    'state_changed',
                    null, // Progress function (b·ªè qua)
                    (error) => { // Error function
                        reject(error);
                    },
                    async () => { // Complete function
                        try {
                            const downloadURL = await imageRef.getDownloadURL();
                            resolve(downloadURL);
                        } catch (e) {
                            reject(e);
                        }
                    }
                );
            });
            uploadPromises.push(promise);
        }

        return Promise.all(uploadPromises);
    }
    
    // =======================================================
    // 3. LOGIC X√ìA & C·∫¨P NH·∫¨T ·∫¢NH (DELETE/UPDATE IMAGES)
    // =======================================================
    
    // H√†m l·∫•y Storage Path t·ª´ URL
    function getStoragePath(url) {
        // V√≠ d·ª• URL: https://firebasestorage.googleapis.com/v0/b/project.appspot.com/o/properties%2Ftemp_...%2Fimage.jpg?...
        const pathMatch = url.match(/\/o\/(.+?)\?alt/);
        if (pathMatch && pathMatch[1]) {
            // Decode URI v√† thay th·∫ø '%2F' th√†nh '/'
            return decodeURIComponent(pathMatch[1]);
        }
        return null;
    }

    // H√†m x√≥a file ·∫£nh kh·ªèi Storage
    async function deleteFileFromStorage(imageUrl) {
        const path = getStoragePath(imageUrl);
        if (path) {
            const fileRef = firebase.storage().ref(path);
            await fileRef.delete();
            console.log(`ƒê√£ x√≥a file: ${path}`);
        }
    }

    // H√†m X√ìA B·∫§T ƒê·ªòNG S·∫¢N HO√ÄN TO√ÄN (DELETE)
    async function deleteProperty(propertyId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA Vƒ®NH VI·ªÑN b·∫•t ƒë·ªông s·∫£n n√†y kh√¥ng?')) return;
        
        try {
            const prop = properties.find(p => p.id === propertyId);
            if (prop && prop.images) {
                // X√≥a t·∫•t c·∫£ file ·∫£nh li√™n quan
                await Promise.all(prop.images.map(url => deleteFileFromStorage(url)));
            }
            
            // X√≥a Document Firestore
            await propertiesRef.doc(propertyId).delete();
            alert('ƒê√£ x√≥a b·∫•t ƒë·ªông s·∫£n v√† c√°c file ·∫£nh th√†nh c√¥ng!');
        } catch (error) {
            console.error("L·ªói khi x√≥a: ", error);
            alert("L·ªói khi x√≥a d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra console.");
        }
    }

    // H√†m x√≥a ·∫£nh c≈© trong Modal (ƒê√É C·∫¨P NH·∫¨T LOGIC X√ìA FILE)
    async function deleteImage(propertyId, imageUrl) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h√¨nh ·∫£nh n√†y kh√¥ng?')) return;

        const propertyIndex = properties.findIndex(p => p.id === propertyId);
        if (propertyIndex === -1) return;

        try {
            await deleteFileFromStorage(imageUrl); // X√≥a file tr√™n Storage

            // C·∫≠p nh·∫≠t m·∫£ng URL tr√™n Firestore
            properties[propertyIndex].images = properties[propertyIndex].images.filter(img => img !== imageUrl);
            
            await propertiesRef.doc(propertyId).update({
                images: properties[propertyIndex].images
            });

            openImageModal(propertyId); // C·∫≠p nh·∫≠t l·∫°i giao di·ªán Modal
        } catch (error) {
            console.error("L·ªói khi x√≥a ·∫£nh: ", error);
            alert("L·ªói khi x√≥a ·∫£nh. Vui l√≤ng ki·ªÉm tra console.");
        }
    }

    // H√†m l∆∞u c·∫≠p nh·∫≠t ·∫£nh (t·ª´ Modal) - (UPDATE IMAGES - ƒê√É C·∫¨P NH·∫¨T LOGIC T·∫¢I FILE)
    async function saveUpdatedImages() {
        const propertyId = document.getElementById('current-property-id').value; 
        const propertyIndex = properties.findIndex(p => p.id === propertyId);
        if (propertyIndex === -1) {
            alert('L·ªói: Kh√¥ng t√¨m th·∫•y b·∫•t ƒë·ªông s·∫£n ƒë·ªÉ c·∫≠p nh·∫≠t.');
            return;
        }
        
        if (newImageFiles.length === 0) {
            alert('Kh√¥ng c√≥ ·∫£nh m·ªõi n√†o ƒë∆∞·ª£c ch·ªçn.');
            return;
        }

        try {
            // T·∫£i ·∫£nh m·ªõi l√™n Storage (d√πng ID t√†i s·∫£n l√†m t√™n folder)
            const newImageUrls = await uploadImagesToStorage(newImageFiles, propertyId); 
            
            const currentImages = properties[propertyIndex].images || [];
            const updatedImages = [...currentImages, ...newImageUrls];
            
            // C·∫≠p nh·∫≠t m·∫£ng URL tr√™n Firestore
            await propertiesRef.doc(propertyId).update({
                images: updatedImages
            });
            
            alert('ƒê√£ c·∫≠p nh·∫≠t h√¨nh ·∫£nh th√†nh c√¥ng!');
            closeModal('imageModal');
            newImageFiles = []; // Reset
        } catch (error) {
            console.error("L·ªói khi c·∫≠p nh·∫≠t ·∫£nh: ", error);
            alert("L·ªói khi c·∫≠p nh·∫≠t ·∫£nh. Vui l√≤ng ki·ªÉm tra console.");
        }
    }

    // =======================================================
    // 4. LOGIC C·∫¨P NH·∫¨T CHI TI·∫æT & READ (Gi·ªØ nguy√™n)
    // =======================================================
    
    // H√†m m·ªü Modal C·∫≠p nh·∫≠t Chi ti·∫øt (Gi·ªØ nguy√™n)
    function openDetailsModal(propertyId) {
        // ... (Logic Populate form)
    }

    // H√†m l∆∞u Chi ti·∫øt C·∫≠p nh·∫≠t (Gi·ªØ nguy√™n)
    function savePropertyDetails() {
        // ... (Logic chu·∫©n h√≥a v√† g·ª≠i update l√™n Firestore)
    }

    // Listener l·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi d·ªØ li·ªáu t·ª´ Firestore (Gi·ªØ nguy√™n)
    propertiesRef.onSnapshot((snapshot) => {
        properties = []; 
        snapshot.forEach(doc => {
            properties.push({
                ...doc.data(),
                id: doc.id 
            });
        });
        
        searchProperties();
    });

    // H√†m ƒë√≥ng Modal chung
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        
        if(modalId === 'imageModal') {
            document.getElementById('update-image-upload').value = null;
            newImageFiles = []; 
        }
    }
    
    // X·ª≠ l√Ω ƒë√≥ng modal khi click ra ngo√†i
    window.onclick = function(event) {
        const imageModal = document.getElementById('imageModal');
        const detailsModal = document.getElementById('detailsModal');
        if (event.target === imageModal) {
            closeModal('imageModal');
        }
        if (event.target === detailsModal) {
            closeModal('detailsModal');
        }
    }
    
    // H√†m t√¨m ki·∫øm v√† l·ªçc chi ti·∫øt (FILTER) - (Gi·ªØ nguy√™n)
    function searchProperties() {
        // ... (Logic l·ªçc) ...
        // ... (Logic hi·ªÉn th·ªã k·∫øt qu·∫£) ...
    }

</script>
</body>
</html>


