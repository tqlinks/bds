<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Web Qu·∫£n L√Ω & T√¨m Ki·∫øm B·∫•t ƒê·ªông S·∫£n Online (Firebase)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* ======================================================= */
        /* CSS CHO GIAO DI·ªÜN CHUNG */
        /* ======================================================= */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            margin: auto;
        }
        .column {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .column-left {
            flex: 1.5;
        }
        .column-right {
            flex: 2;
        }
        h2 {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="file"],
        .form-group select,
        .filter-item input[type="text"],
        .filter-item input[type="number"],
        .filter-item select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        /* Input Inline & Filter Group */
        .form-group-inline,
        .filter-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group-inline .inline-item,
        .filter-group .filter-item {
            flex: 1;
        }
        .form-group-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            height: 40px; 
            margin-top: 25px;
        }
        .form-group-checkbox input[type="checkbox"] {
            width: 20px; 
            height: 20px;
            margin: 0;
            padding: 0;
            border: 1px solid #ccc;
        }
        .filter-item-checkbox { 
            align-self: flex-end; 
            padding-bottom: 5px;
        }
        /* N√∫t chung */
        button {
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #218838;
        }
        .delete-btn {
            background-color: #dc3545;
            padding: 5px 10px;
            font-size: 14px;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .update-img-btn {
            background-color: #007bff;
            padding: 5px 10px;
            font-size: 14px;
        }
        .update-img-btn:hover {
            background-color: #0056b3;
        }
        /* ======================================================= */
        /* CSS CHO K·∫æT QU·∫¢ V√Ä H√åNH ·∫¢NH */
        /* ======================================================= */
        .property-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            padding: 15px;
            display: flex;
            gap: 15px;
            align-items: flex-start;
            background-color: #fafafa;
            position: relative;
        }
        .property-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        /* Container ·∫£nh trong list item */
        .property-images {
            display: flex; 
            gap: 5px; 
            flex-wrap: wrap; 
            max-width: 150px; 
            cursor: pointer; 
            border: 1px solid #ccc; 
            padding: 5px;
            border-radius: 4px;
            margin-top: 5px;
        }
        .property-images img {
            max-width: 100%; 
            height: 70px; 
            width: auto;
            border-radius: 4px;
            object-fit: cover;
        }
        .property-details-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px 10px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        /* CSS xem tr∆∞·ªõc nhi·ªÅu ·∫£nh (input form) */
        #preview-area-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        #preview-area-images img {
            max-width: 100px; 
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        /* ======================================================= */
        /* CSS CHO MODAL / LIGHTBOX */
        /* ======================================================= */
        .modal-overlay {
            display: none; 
            position: fixed;
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 8px;
            width: 90%; 
            max-width: 900px; 
            position: relative;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 20px;
            z-index: 1001;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            padding: 0 8px;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: #ff0000;
        }
        /* Modal Gallery Content */
        #modal-gallery {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background-color: #fff;
            margin-bottom: 20px;
        }
        .current-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .image-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }
        .image-wrapper img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }
        .delete-image-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            text-align: center;
            padding: 0;
        }
        .new-images-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .new-images-preview img {
            max-width: 80px;
            height: 80px;
            object-fit: cover;
            border: 1px solid #007bff;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div class="container">

    <div class="column column-left">
        <h2>‚ûï Nh·∫≠p Th√¥ng Tin B·∫•t ƒê·ªông S·∫£n</h2>
        <form id="property-form">
            <div class="form-group">
                <label for="name">T√™n / Ti√™u ƒë·ªÅ:</label>
                <input type="text" id="name" required placeholder="V√≠ d·ª•: CƒÉn h·ªô cao c·∫•p Qu·∫≠n 1">
            </div>
            <div class="form-group">
                <label for="phone">S·ªë ƒëi·ªán tho·∫°i:</label>
                <input type="text" id="phone" required placeholder="090...">
            </div>
            <div class="form-group">
                <label for="address">ƒê·ªãa ch·ªâ:</label>
                <input type="text" id="address" required placeholder="123 ƒê∆∞·ªùng ABC, Ph∆∞·ªùng X, Qu·∫≠n Y">
            </div>
            
            <div class="form-group-inline">
                <div class="inline-item">
                    <label for="price">Gi√° (VNƒê/t·ª∑):</label>
                    <input type="number" id="price" step="0.01" required placeholder="V√≠ d·ª•: 3.5 (t·ª∑)">
                </div>
                <div class="inline-item">
                    <label for="area">Di·ªán t√≠ch (m¬≤):</label>
                    <input type="number" id="area" step="0.1" required placeholder="V√≠ d·ª•: 80.5">
                </div>
            </div>

            <div class="form-group">
                <label for="direction">H∆∞·ªõng Nh√†:</label>
                <select id="direction" required>
                    <option value="">Ch·ªçn H∆∞·ªõng</option>
                    <option value="ƒê√¥ng">ƒê√¥ng</option>
                    <option value="T√¢y">T√¢y</option>
                    <option value="Nam">Nam</option>
                    <option value="B·∫Øc">B·∫Øc</option>
                    <option value="ƒê√¥ng-B·∫Øc">ƒê√¥ng-B·∫Øc</option>
                    <option value="ƒê√¥ng-Nam">ƒê√¥ng-Nam</option>
                    <option value="T√¢y-B·∫Øc">T√¢y-B·∫Øc</option>
                    <option value="T√¢y-Nam">T√¢y-Nam</option>
                    <option value="CCh∆∞a c·∫≠p nh·∫≠t">Ch∆∞a c·∫≠p nh·∫≠t</option>
                </select>
            </div>
            
            <div class="form-group-inline">
                <div class="inline-item">
                    <label for="bedrooms">S·ªë PN:</label>
                    <input type="number" id="bedrooms" min="0" required placeholder="Ph√≤ng ng·ªß">
                </div>
                <div class="inline-item">
                    <label for="wc">S·ªë WC:</label>
                    <input type="number" id="wc" min="0" required placeholder="Ph√≤ng WC">
                </div>
                <div class="inline-item">
                    <label for="kitchens">S·ªë B·∫øp:</label>
                    <input type="number" id="kitchens" min="0" required placeholder="B·∫øp">
                </div>
                <div class="inline-item">
                    <label for="floors">S·ªë L·∫ßu:</label>
                    <input type="number" id="floors" min="0" required placeholder="S·ªë t·∫ßng">
                </div>
            </div>

            <div class="form-group-inline">
                <div class="inline-item">
                    <label for="legal">T√¨nh tr·∫°ng S·ªï:</label>
                    <select id="legal" required>
                        <option value="">Ch·ªçn T√¨nh tr·∫°ng</option>
                        <option value="S·ªï H·ªìng">S·ªï H·ªìng</option>
                        <option value="S·ªï ƒê·ªè">S·ªï ƒê·ªè</option>
                        <option value="H·ª£p ƒê·ªìng Mua B√°n">H·ª£p ƒê·ªìng Mua B√°n</option>
                        <option value="Ch∆∞a c√≥ S·ªï">Ch∆∞a c√≥ S·ªï</option>
                    </select>
                </div>
                <div class="inline-item">
                    <div class="form-group-checkbox">
                        <input type="checkbox" id="loanable">
                        <label for="loanable" style="margin-bottom: 0;">C√≥ th·ªÉ vay th√™m</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="image-upload">H√¨nh ·∫£nh (C√≥ th·ªÉ ch·ªçn nhi·ªÅu):</label>
                <input type="file" id="image-upload" accept="image/*" multiple required>
            </div>
            
            <div class="form-group" id="preview-area">
                <label>Xem tr∆∞·ªõc ·∫£nh ƒë√£ ch·ªçn:</label>
                <div id="preview-area-images"></div>
            </div>
            
            <button type="submit">L∆∞u Th√¥ng Tin</button>
        </form>
        <p style="margin-top: 15px; font-size: 0.9em; color: #6c757d;">*D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr·ªØ tr√™n Firebase Realtime Database.</p>
    </div>

    <div class="column column-right">
        <h2>üîç T√¨m Ki·∫øm Chi Ti·∫øt</h2>
        
        <div class="filter-group">
            <div class="filter-item">
                <label for="filter-name">T√™n / Ti√™u ƒë·ªÅ:</label>
                <input type="text" id="filter-name" placeholder="T√¨m ki·∫øm theo T√™n..." onkeyup="searchProperties()">
            </div>
            <div class="filter-item">
                <label for="filter-phone">S·ªë ƒëi·ªán tho·∫°i:</label>
                <input type="text" id="filter-phone" placeholder="T√¨m ki·∫øm theo SƒêT..." onkeyup="searchProperties()">
            </div>
            <div class="filter-item">
                <label for="filter-address">ƒê·ªãa ch·ªâ:</label>
                <input type="text" id="filter-address" placeholder="T√¨m ki·∫øm theo ƒê·ªãa ch·ªâ..." onkeyup="searchProperties()">
            </div>
        </div>
        
        <div class="filter-group">
            <div class="filter-item">
                <label for="filter-price-min">Gi√° min (t·ª∑ VNƒê):</label>
                <input type="number" id="filter-price-min" step="0.01" placeholder="Min Gi√°..." onkeyup="searchProperties()">
            </div>
            <div class="filter-item">
                <label for="filter-price-max">Gi√° max (t·ª∑ VNƒê):</label>
                <input type="number" id="filter-price-max" step="0.01" placeholder="Max Gi√°..." onkeyup="searchProperties()">
            </div>
            <div class="filter-item">
                <label for="filter-area-min">Di·ªán t√≠ch min (m¬≤):</label>
                <input type="number" id="filter-area-min" step="0.1" placeholder="Min Di·ªán t√≠ch..." onkeyup="searchProperties()">
            </div>
        </div>

        <div class="filter-group">
            <div class="filter-item">
                <label for="filter-direction">H∆∞·ªõng Nh√†:</label>
                <select id="filter-direction" onchange="searchProperties()">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="ƒê√¥ng">ƒê√¥ng</option>
                    <option value="T√¢y">T√¢y</option>
                    <option value="Nam">Nam</option>
                    <option value="B·∫Øc">B·∫Øc</option>
                    <option value="ƒê√¥ng-B·∫Øc">ƒê√¥ng-B·∫Øc</option>
                    <option value="ƒê√¥ng-Nam">ƒê√¥ng-Nam</option>
                    <option value="T√¢y-B·∫Øc">T√¢y-B·∫Øc</option>
                    <option value="T√¢y-Nam">T√¢y-Nam</option>
                </select>
            </div>
            <div class="filter-item">
                <label for="filter-legal">T√¨nh tr·∫°ng S·ªï:</label>
                <select id="filter-legal" onchange="searchProperties()">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="S·ªï H·ªìng">S·ªï H·ªìng</option>
                    <option value="S·ªï ƒê·ªè">S·ªï ƒê·ªè</option>
                    <option value="H·ª£p ƒê·ªìng Mua B√°n">H·ª£p ƒê·ªìng Mua B√°n</option>
                    <option value="Ch∆∞a c√≥ S·ªï">Ch∆∞a c√≥ S·ªï</option>
                </select>
            </div>
            <div class="filter-item filter-item-checkbox">
                <div class="form-group-checkbox">
                    <input type="checkbox" id="filter-loanable" onchange="searchProperties()">
                    <label for="filter-loanable">Ch·ªâ hi·ªán BƒêS c√≥ th·ªÉ vay</label>
                </div>
            </div>
        </div>

        <div class="filter-group">
            <div class="filter-item">
                <label for="filter-bedrooms-min">PN t·ªëi thi·ªÉu:</label>
                <input type="number" id="filter-bedrooms-min" min="0" placeholder="Min PN" onkeyup="searchProperties()">
            </div>
            <div class="filter-item">
                <label for="filter-wc-min">WC t·ªëi thi·ªÉu:</label>
                <input type="number" id="filter-wc-min" min="0" placeholder="Min WC" onkeyup="searchProperties()">
            </div>
            <div class="filter-item">
                <label for="filter-floors-min">L·∫ßu t·ªëi thi·ªÉu:</label>
                <input type="number" id="filter-floors-min" min="0" placeholder="Min L·∫ßu" onkeyup="searchProperties()">
            </div>
        </div>
        
        <h3>Danh s√°ch K·∫øt qu·∫£</h3>
        <ul id="results-list">
        </ul>
    </div>

</div>

<div id="imageModal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <h3 id="modal-title"></h3>
        
        <input type="hidden" id="current-property-id">

        <h4>·∫¢nh Hi·ªán T·∫°i (B·∫•m X ƒë·ªÉ x√≥a)</h4>
        <div id="modal-gallery" class="current-images-grid">
            </div>

        <h4 style="margin-top: 20px;">Th√™m ·∫¢nh M·ªõi</h4>
        <div class="form-group-inline">
            <div class="inline-item">
                <input type="file" id="update-image-upload" accept="image/*" multiple>
            </div>
        </div>
        
        <div class="new-images-preview" id="new-images-preview">
             </div>

        <button onclick="saveUpdatedImages()" style="margin-top: 15px; width: 100%;">L∆∞u C·∫≠p Nh·∫≠t ·∫¢nh</button>
    </div>
</div>

<script>
    // =======================================================
    // 1. KH·ªûI T·∫†O FIREBASE
    // =======================================================

    // THAY TH·∫æ CONFIG N√ÄY B·∫∞NG C·∫§U H√åNH TH·ª∞C T·∫æ C·ª¶A D·ª∞ √ÅN FIREBASE C·ª¶A B·∫†N
    const firebaseConfig = {
    apiKey: "AIzaSyBBFhxxkIZSguuMV5AZzhLSWa19LYXMOY8", 
    authDomain: "bdss-1f754.firebaseapp.com",
    projectId: "bdss-1f754",
    // ƒê√¢y l√† URL c·ªßa Realtime Database
    databaseURL: "https://bdss-1f754-default-rtdb.asia-southeast1.firebasedatabase.app/", 
    storageBucket: "bdss-1f754.firebasestorage.app",
    messagingSenderId: "1081373432468",
    appId: "1:1081373432468:web:f38cab72330d75de67b281"
};
    // Kh·ªüi t·∫°o Firebase
    firebase.initializeApp(firebaseConfig);

    // Tham chi·∫øu ƒë·∫øn Realtime Database
    const database = firebase.database();
    // Tham chi·∫øu ƒë·∫øn node ch√≠nh n∆°i b·∫°n l∆∞u tr·ªØ BƒêS
    const propertiesRef = database.ref('properties'); 

    // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu ƒë√£ t·∫£i v·ªÅ t·ª´ Firebase
    let properties = []; 
    // Bi·∫øn t·∫°m ƒë·ªÉ l∆∞u tr·ªØ c√°c ·∫£nh m·ªõi ƒë∆∞·ª£c ch·ªçn trong Modal
    let newImagesToUpload = [];

    // =======================================================
    // 2. LOGIC XEM TR∆Ø·ªöC V√Ä N·ªòP D·ªÆ LI·ªÜU
    // =======================================================
    
    // H√†m x·ª≠ l√Ω xem tr∆∞·ªõc nhi·ªÅu ·∫£nh (cho form nh·∫≠p li·ªáu)
    function previewImages() {
        const fileInput = document.getElementById('image-upload');
        const previewContainer = document.getElementById('preview-area-images');
        previewContainer.innerHTML = ''; 

        if (fileInput.files.length > 0) {
            Array.from(fileInput.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = "·∫¢nh xem tr∆∞·ªõc";
                    previewContainer.appendChild(img);
                }
                reader.readAsDataURL(file);
            });
        }
    }

    // H√†m x·ª≠ l√Ω xem tr∆∞·ªõc ·∫£nh m·ªõi (cho Modal c·∫≠p nh·∫≠t)
    function previewNewImages(event) {
        const fileInput = event.target;
        const files = Array.from(fileInput.files);
        const previewContainer = document.getElementById('new-images-preview');
        previewContainer.innerHTML = ''; 
        newImagesToUpload = []; // Reset m·∫£ng ·∫£nh m·ªõi

        if (files.length === 0) return;

        let filesProcessedCount = 0;
        
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                // 1. L∆∞u Base64 v√†o m·∫£ng t·∫°m
                newImagesToUpload.push(e.target.result);
                
                // 2. Hi·ªÉn th·ªã xem tr∆∞·ªõc
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = "·∫¢nh m·ªõi xem tr∆∞·ªõc";
                previewContainer.appendChild(img);

                filesProcessedCount++;
            };
            reader.readAsDataURL(file);
        });
    }
    
    // L·∫ÆNG NGHE S·ª∞ KI·ªÜN CH·ªåN ·∫¢NH FORM
    document.getElementById('image-upload').addEventListener('change', previewImages);

    // L·∫ÆNG NGHE S·ª∞ KI·ªÜN CH·ªåN ·∫¢NH TRONG MODAL
    document.getElementById('update-image-upload').addEventListener('change', previewNewImages);


    // X·ª≠ l√Ω Form n·ªôp d·ªØ li·ªáu (CREATE)
    document.getElementById('property-form').addEventListener('submit', function(e) {
        // =======================================================
// 2. LOGIC XEM TR∆Ø·ªöC V√Ä N·ªòP D·ªÆ LI·ªÜU (PH·∫¶N ƒê√É CH·ªàNH S·ª¨A)
// =======================================================

// ... (c√°c h√†m previewImages, previewNewImages, v√† listeners v·∫´n gi·ªØ nguy√™n) ...

// X·ª≠ l√Ω Form n·ªôp d·ªØ li·ªáu (CREATE)
document.getElementById('property-form').addEventListener('submit', function(e) {
    e.preventDefault();

    // L·∫•y gi√° tr·ªã form v√† √ÅP D·ª§NG LOGIC M·∫∂C ƒê·ªäNH

    const name = document.getElementById('name').value.trim() || "Ch∆∞a c·∫≠p nh·∫≠t";
    const phone = document.getElementById('phone').value.trim() || "Ch∆∞a c·∫≠p nh·∫≠t";
    const address = document.getElementById('address').value.trim() || "Ch∆∞a c·∫≠p nh·∫≠t";
    
    // Gi√° tr·ªã s·ªë (Number): N·∫øu tr·ªëng (empty string), parseFloat s·∫Ω tr·∫£ v·ªÅ NaN, ta ƒë·∫∑t n√≥ th√†nh null.
    const priceValue = document.getElementById('price').value.trim();
    const price = priceValue ? parseFloat(priceValue) : null; 
    
    const areaValue = document.getElementById('area').value.trim();
    const area = areaValue ? parseFloat(areaValue) : null; 

    // C√°c tr∆∞·ªùng select/option: N·∫øu gi√° tr·ªã l√† chu·ªói r·ªóng (""), ta quy th√†nh "Ch∆∞a c·∫≠p nh·∫≠t".
    const direction = document.getElementById('direction').value || "Ch∆∞a c·∫≠p nh·∫≠t";

    const bedroomsValue = document.getElementById('bedrooms').value.trim();
    const bedrooms = bedroomsValue ? parseInt(bedroomsValue) : null;
    
    const wcValue = document.getElementById('wc').value.trim();
    const wc = wcValue ? parseInt(wcValue) : null;
    
    const kitchensValue = document.getElementById('kitchens').value.trim();
    const kitchens = kitchensValue ? parseInt(kitchensValue) : null;
    
    const floorsValue = document.getElementById('floors').value.trim();
    const floors = floorsValue ? parseInt(floorsValue) : null;

    const legal = document.getElementById('legal').value || "Ch∆∞a c·∫≠p nh·∫≠t";
    
    // Checkbox (Boolean): N·∫øu kh√¥ng ƒë∆∞·ª£c ch·ªçn, gi√° tr·ªã m·∫∑c ƒë·ªãnh l√† false (do c√°ch l·∫•y value.checked). Kh√¥ng c·∫ßn thay ƒë·ªïi.
    const loanable = document.getElementById('loanable').checked;

    const imageFiles = document.getElementById('image-upload').files; 

    // Y√™u c·∫ßu t·ªëi thi·ªÉu: B·∫Øt bu·ªôc ph·∫£i c√≥ h√¨nh ·∫£nh 
    if (imageFiles.length === 0) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h√¨nh ·∫£nh.');
        return;
    }

    const imageBase64Array = []; 
    let filesProcessed = 0;
    
    // ƒê·ªçc t·ª´ng file v√† l∆∞u Base64 (ph·∫ßn n√†y gi·ªØ nguy√™n)
    Array.from(imageFiles).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(event) {
            imageBase64Array.push(event.target.result);
            filesProcessed++;

            if (filesProcessed === imageFiles.length) {
                const newProperty = {
                    name: name,
                    phone: phone,
                    address: address,
                    price: price, // C√≥ th·ªÉ l√† null
                    area: area,   // C√≥ th·ªÉ l√† null
                    images: imageBase64Array, 
                    
                    direction: direction,
                    bedrooms: bedrooms, // C√≥ th·ªÉ l√† null
                    wc: wc,             // C√≥ th·ªÉ l√† null
                    kitchens: kitchens, // C√≥ th·ªÉ l√† null
                    floors: floors,     // C√≥ th·ªÉ l√† null
                    legal: legal,
                    loanable: loanable // false
                };

                // G·ª¨I D·ªÆ LI·ªÜU L√äN FIREBASE (ph·∫ßn n√†y gi·ªØ nguy√™n)
                propertiesRef.push(newProperty)
                    .then(() => {
                        alert('ƒê√£ l∆∞u th√¥ng tin b·∫•t ƒë·ªông s·∫£n th√†nh c√¥ng!');
                        // Reset form v√† x√≥a ·∫£nh xem tr∆∞·ªõc
                        document.getElementById('property-form').reset();
                        document.getElementById('preview-area-images').innerHTML = ''; 
                    })
                    .catch(error => {
                        console.error("L·ªói khi l∆∞u v√†o Firebase: ", error);
                        alert("L·ªói khi l∆∞u d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra console.");
                    });
            }
        };
        reader.readAsDataURL(file);
    });
});
    // =======================================================
    // 3. LOGIC X√ìA & C·∫¨P NH·∫¨T ·∫¢NH (UPDATE/DELETE)
    // =======================================================

    // H√†m X√ìA B·∫§T ƒê·ªòNG S·∫¢N HO√ÄN TO√ÄN (DELETE)
    function deleteProperty(propertyId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA Vƒ®NH VI·ªÑN b·∫•t ƒë·ªông s·∫£n n√†y kh·ªèi danh s√°ch kh√¥ng?')) return;

        // X√≥a tr√™n Firebase (propertyId l√† Firebase Key)
        propertiesRef.child(propertyId).remove()
            .then(() => {
                alert('ƒê√£ x√≥a b·∫•t ƒë·ªông s·∫£n th√†nh c√¥ng!');
                // Firebase Listener s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t danh s√°ch.
            })
            .catch(error => {
                 console.error("L·ªói khi x√≥a tr√™n Firebase: ", error);
                 alert("L·ªói khi x√≥a d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra console.");
            });
    }

    // H√†m x√≥a ·∫£nh c≈© trong Modal
    function deleteImage(propertyId, imageBase64) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h√¨nh ·∫£nh n√†y kh√¥ng?')) return;

        const propertyIndex = properties.findIndex(p => p.id === propertyId);
        if (propertyIndex === -1) return;

        // L·ªçc b·ªè h√¨nh ·∫£nh kh·ªèi m·∫£ng c·ª•c b·ªô
        properties[propertyIndex].images = properties[propertyIndex].images.filter(img => img !== imageBase64);

        // C·∫≠p nh·∫≠t l·∫°i m·∫£ng ·∫£nh m·ªõi l√™n Firebase
        propertiesRef.child(propertyId).update({
            images: properties[propertyIndex].images
        })
        .then(() => {
             // C·∫≠p nh·∫≠t l·∫°i giao di·ªán Modal ngay l·∫≠p t·ª©c
            openModal(propertyId);
            // Kh√¥ng c·∫ßn g·ªçi searchProperties() v√¨ update tr√™n Firebase s·∫Ω k√≠ch ho·∫°t listener
        })
        .catch(error => {
            console.error("L·ªói khi x√≥a ·∫£nh kh·ªèi Firebase: ", error);
            alert("L·ªói khi x√≥a ·∫£nh. Vui l√≤ng ki·ªÉm tra console.");
        });
    }

    // H√†m l∆∞u c·∫≠p nh·∫≠t ·∫£nh (t·ª´ Modal) - (UPDATE)
    function saveUpdatedImages() {
        const propertyId = document.getElementById('current-property-id').value; 
        const propertyIndex = properties.findIndex(p => p.id === propertyId);
        if (propertyIndex === -1) {
            alert('L·ªói: Kh√¥ng t√¨m th·∫•y b·∫•t ƒë·ªông s·∫£n ƒë·ªÉ c·∫≠p nh·∫≠t.');
            return;
        }

        // L·∫•y danh s√°ch ·∫£nh hi·ªán t·∫°i (sau khi ƒë√£ x√≥a n·∫øu c√≥)
        const currentImages = properties[propertyIndex].images || [];
        
        // Gh√©p ·∫£nh c≈© v√† ·∫£nh m·ªõi
        const updatedImages = [...currentImages, ...newImagesToUpload];
        
        if (updatedImages.length === 0) {
            alert('L·ªói: Kh√¥ng th·ªÉ l∆∞u v√¨ kh√¥ng c√≥ h√¨nh ·∫£nh n√†o ƒë∆∞·ª£c ƒë√≠nh k√®m.');
            return;
        }
        
        // C·∫≠p nh·∫≠t m·∫£ng ·∫£nh m·ªõi l√™n Firebase
        propertiesRef.child(propertyId).update({
            images: updatedImages
        })
        .then(() => {
            alert('ƒê√£ c·∫≠p nh·∫≠t h√¨nh ·∫£nh th√†nh c√¥ng!');
            
            // Reset Modal v√† c·∫≠p nh·∫≠t danh s√°ch
            closeModal();
            
            // ƒê·∫∑t l·∫°i bi·∫øn t·∫°m
            newImagesToUpload = [];
        })
        .catch(error => {
            console.error("L·ªói khi c·∫≠p nh·∫≠t ·∫£nh: ", error);
            alert("L·ªói khi c·∫≠p nh·∫≠t ·∫£nh. Vui l√≤ng ki·ªÉm tra console.");
        });
    }

    // =======================================================
    // 4. LOGIC HI·ªÇN TH·ªä D·ªÆ LI·ªÜU & MODAL (READ/DISPLAY)
    // =======================================================

    // Listener l·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi d·ªØ li·ªáu t·ª´ Firebase
    propertiesRef.on('value', (snapshot) => {
        properties = []; // X√≥a d·ªØ li·ªáu c≈©
        const data = snapshot.val(); // L·∫•y d·ªØ li·ªáu d·∫°ng ƒë·ªëi t∆∞·ª£ng
        
        if (data) {
            // L·∫∑p qua ƒë·ªëi t∆∞·ª£ng data (key l√† Firebase ID, value l√† object BƒêS)
            for (let key in data) {
                // Th√™m ID c·ªßa Firebase v√†o ƒë·ªëi t∆∞·ª£ng BƒêS ƒë·ªÉ ti·ªán cho vi·ªác thao t√°c sau n√†y (x√≥a/update)
                properties.push({
                    ...data[key],
                    id: key // L∆∞u kh√≥a Firebase l√†m ID
                });
            }
        }
        
        // Sau khi t·∫£i xong d·ªØ li·ªáu, g·ªçi h√†m t√¨m ki·∫øm/hi·ªÉn th·ªã
        searchProperties();
        console.log("ƒê√£ t·∫£i d·ªØ li·ªáu BƒêS t·ª´ Firebase.");
    });
    
    // H√†m m·ªü modal v√† hi·ªÉn th·ªã ·∫£nh chi ti·∫øt/c·∫≠p nh·∫≠t
    function openModal(propertyId) {
        const property = properties.find(p => p.id === propertyId);
        if (!property) return;

        const modal = document.getElementById('imageModal');
        const gallery = document.getElementById('modal-gallery');
        const title = document.getElementById('modal-title');
        
        // Reset ·∫£nh m·ªõi t·∫°m v√† input file
        newImagesToUpload = [];
        document.getElementById('update-image-upload').value = null;
        document.getElementById('new-images-preview').innerHTML = ''; 
        
        // L∆∞u ID BƒêS ƒëang thao t√°c (l√† Firebase Key)
        document.getElementById('current-property-id').value = propertyId;
        
        title.textContent = 'C·∫≠p nh·∫≠t b·ªô s∆∞u t·∫≠p ·∫£nh: ' + property.name;
        gallery.innerHTML = ''; // X√≥a ·∫£nh c≈©

        if (property.images && property.images.length > 0) {
            property.images.forEach(imgSrc => {
                const wrapper = document.createElement('div');
                wrapper.className = 'image-wrapper';
                
                const img = document.createElement('img');
                img.src = imgSrc;
                img.alt = property.name;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-image-btn';
                deleteBtn.textContent = 'X';
                deleteBtn.title = 'X√≥a ·∫£nh n√†y';
                // Th√™m s·ª± ki·ªán x√≥a ·∫£nh
                deleteBtn.onclick = () => deleteImage(property.id, imgSrc); 
                
                wrapper.appendChild(img);
                wrapper.appendChild(deleteBtn);
                gallery.appendChild(wrapper);
            });
        } else {
            gallery.innerHTML = '<p style="text-align: center;">Hi·ªán kh√¥ng c√≥ h√¨nh ·∫£nh n√†o.</p>';
        }

        modal.style.display = 'flex';
    }

    // H√†m ƒë√≥ng modal
    function closeModal() {
        document.getElementById('imageModal').style.display = 'none';
        
        // Reset input file trong modal
        document.getElementById('update-image-upload').value = null;
        newImagesToUpload = []; // X√≥a ·∫£nh m·ªõi t·∫°m
    }

    // X·ª≠ l√Ω ƒë√≥ng modal khi click ra ngo√†i
    window.onclick = function(event) {
        const modal = document.getElementById('imageModal');
        if (event.target === modal) {
            closeModal();
        }
    }


    // H√†m t√¨m ki·∫øm v√† l·ªçc chi ti·∫øt (FILTER)
    function searchProperties() {
        // L·∫•y gi√° tr·ªã t·ª´ c√°c √¥ l·ªçc
        const filterName = document.getElementById('filter-name').value.toLowerCase();
        const filterPhone = document.getElementById('filter-phone').value.toLowerCase();
        const filterAddress = document.getElementById('filter-address').value.toLowerCase();
        const filterPriceMin = parseFloat(document.getElementById('filter-price-min').value);    
        const filterPriceMax = parseFloat(document.getElementById('filter-price-max').value);    
        const filterAreaMin = parseFloat(document.getElementById('filter-area-min').value);    
        const filterDirection = document.getElementById('filter-direction').value;
        const filterLegal = document.getElementById('filter-legal').value;
        const filterLoanable = document.getElementById('filter-loanable').checked;
        const filterBedroomsMin = parseInt(document.getElementById('filter-bedrooms-min').value);
        const filterWCMin = parseInt(document.getElementById('filter-wc-min').value);
        const filterFloorsMin = parseInt(document.getElementById('filter-floors-min').value);


        const resultsList = document.getElementById('results-list');
        resultsList.innerHTML = '';

        // L·ªçc danh s√°ch t√†i s·∫£n d·ª±a tr√™n t·∫•t c·∫£ c√°c ti√™u ch√≠
        const filteredProperties = properties.filter(prop => {
            const matchName = prop.name.toLowerCase().includes(filterName);
            const matchPhone = prop.phone.toLowerCase().includes(filterPhone);
            const matchAddress = prop.address.toLowerCase().includes(filterAddress);
            const matchPriceMin = isNaN(filterPriceMin) || prop.price >= filterPriceMin;    
            const matchPriceMax = isNaN(filterPriceMax) || prop.price <= filterPriceMax;    
            const matchPrice = matchPriceMin && matchPriceMax;
            const matchArea = isNaN(filterAreaMin) || prop.area >= filterAreaMin;
            const matchDirection = filterDirection === "" || prop.direction === filterDirection;
            const matchLegal = filterLegal === "" || prop.legal === filterLegal;
            const matchLoanable = !filterLoanable || prop.loanable === true;    
            const matchBedrooms = isNaN(filterBedroomsMin) || prop.bedrooms >= filterBedroomsMin;
            const matchWC = isNaN(filterWCMin) || prop.wc >= filterWCMin;
            const matchFloors = isNaN(filterFloorsMin) || prop.floors >= filterFloorsMin;
            
            return matchName && matchPhone && matchAddress && matchPrice && matchArea && 
                   matchDirection && matchLegal && matchLoanable && 
                   matchBedrooms && matchWC && matchFloors;
        });

        if (filteredProperties.length === 0) {
            resultsList.innerHTML = '<p style="text-align: center; color: #dc3545;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o ph√π h·ª£p.</p>';
            return;
        }

        // Hi·ªÉn th·ªã t·ª´ng k·∫øt qu·∫£
        filteredProperties.forEach(prop => {
            const listItem = document.createElement('li');
            listItem.className = 'property-item';
            
            const formattedPrice = prop.price.toLocaleString('vi-VN', { minimumFractionDigits: 2 }) + ' t·ª∑ VNƒê';
            const formattedArea = prop.area.toLocaleString('vi-VN', { minimumFractionDigits: 1 }) + ' m¬≤';

            // T·∫°o chu·ªói HTML cho nhi·ªÅu h√¨nh ·∫£nh (c√≥ th·ªÉ click)
            let imagesHtml = `<div class="property-images" onclick="openModal('${prop.id}')">`; // Truy·ªÅn Firebase Key
            if (prop.images && prop.images.length > 0) {
                const imagesToShow = prop.images.slice(0, 3);    
                imagesToShow.forEach(imgSrc => {
                    imagesHtml += `<img src="${imgSrc}" alt="${prop.name}">`;
                });
            } else {
                imagesHtml += `<img src="https://via.placeholder.com/70x70?text=No+Image" alt="No Image">`;
            }
            imagesHtml += '</div>';

            // Th√™m n√∫t C·∫≠p nh·∫≠t ·∫¢nh v√† n√∫t X√ìA
            const actionsHtml = `
                <div class="property-actions">
                    <button class="update-img-btn" onclick="openModal('${prop.id}')">üñºÔ∏è ·∫¢nh</button>
                    <button class="delete-btn" onclick="deleteProperty('${prop.id}')">üóëÔ∏è X√≥a</button>
                </div>
            `;
            
            listItem.innerHTML = `
                ${imagesHtml}
                <div>
                    <h4>${prop.name} (${prop.address})</h4>
                    <p style="color: #007bff; font-weight: bold; margin: 5px 0 10px;">Gi√°: ${formattedPrice}</p>
                    <div class="property-details-grid">
                        <span>**Di·ªán t√≠ch:** ${formattedArea}</span>
                        <span>**H∆∞·ªõng:** ${prop.direction}</span>
                        <span>**T√¨nh tr·∫°ng S·ªï:** ${prop.legal}</span>
                        <span>**PN:** ${prop.bedrooms}</span>
                        <span>**WC:** ${prop.wc}</span>
                        <span>**L·∫ßu:** ${prop.floors}</span>
                        <span style="grid-column: span 3;">**C√≥ th·ªÉ vay:** ${prop.loanable ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</span>
                        <span style="grid-column: span 3; color: #5cb85c;">**SƒêT:** ${prop.phone}</span>
                    </div>
                </div>
                ${actionsHtml}
            `;
            
            resultsList.appendChild(listItem);
        });
    }

</script>
</body>
</html>


