<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trò Chơi Nhập Captcha Hình Ảnh</title>
    <style>
        /* CSS Cơ Bản */
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        input[type="file"], input[type="text"], button { padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
        button { background-color: #007bff; color: white; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        #setup-area, #game-area, #result-area, #leaderboard-area { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        #game-area, #result-area, #leaderboard-area { display: none; }
        .captcha-image { max-width: 100%; height: auto; border: 2px solid #007bff; border-radius: 5px; margin-bottom: 10px; }
        .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .leaderboard-table th, .leaderboard-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .leaderboard-table th { background-color: #f2f2f2; }
        .error { color: red; margin-bottom: 10px; }
        
        /* CSS cho Setup Actions */
        .setup-actions { display: flex; justify-content: space-between; gap: 10px; }
        .setup-actions button { width: 32%; margin-right: 0 !important; }
        .setup-actions button:last-child { background-color: #dc3545; }
        .setup-actions button:last-child:hover { background-color: #c82333; }
        
        /* CSS cho Footer */
        #main-footer {
            text-align: center;
            margin-top: 30px;
            padding: 10px 0;
            color: #777;
            font-size: 0.9em;
            border-top: 1px solid #ddd;
        }
        #main-footer a {
            color: #007bff;
            text-decoration: none;
        }
        #main-footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Trò Chơi Nhập Captcha Hình Ảnh</h1>

    <div id="setup-area">
        <h2>Bước 1: Thiết Lập Câu Hỏi</h2>
        <p>Tải lên **nhiều hình ảnh** Captcha và nhập **đáp án** tương ứng.</p>

        <input type="file" id="image-upload" accept="image/*" multiple>

        <label for="answers-input">Đáp án (cách nhau bởi dấu phẩy, theo thứ tự tệp):</label>
        <input type="text" id="answers-input" placeholder="Ví dụ: abc, 123, xyz">
        
        <div class="setup-actions">
            <button onclick="saveSetup()">Lưu Thiết Lập Hiện Tại (IndexedDB)</button>
            <button onclick="loadSetup()">Tải Lại Thiết Lập Đã Lưu (IndexedDB)</button>
            <button onclick="clearSavedSetup()">Xóa Thiết Lập Đã Lưu</button>
        </div>

        <button onclick="checkSetup()">Kiểm Tra & Bắt Đầu Trò Chơi</button>

        <div id="setup-status" class="error"></div>
    </div>

    <hr>

    <div id="game-area">
        <h2>Bước 2: Chơi Game!</h2>
        <div id="game-info">
            <p>Câu hỏi: <span id="current-question-index">1</span> / <span id="total-questions">0</span></p>
            <p>Thời gian: <span id="game-timer">0.00</span>s</p>
        </div>
        
        <div style="text-align: center;">
            <img id="captcha-display" class="captcha-image" src="" alt="Captcha Image">
        </div>

        <label for="captcha-input">Nhập đáp án:</label>
        <input type="text" id="captcha-input" onkeypress="handleEnter(event)" autofocus>
        
        <button onclick="submitAnswer()">Gửi Đáp Án</button>
    </div>

    <hr>

    <div id="result-area">
        <h2>Bước 3: Tổng Kết</h2>
        <p>Tổng thời gian: <strong id="final-time"></strong>s</p>
        <p>Số câu đúng: <strong id="correct-count"></strong></p>
        <p>Điểm số (Độ chính xác / Thời gian): <strong id="final-score"></strong></p>
        
        <label for="player-name">Nhập tên của bạn để lưu vào Bảng Xếp Hạng:</label>
        <input type="text" id="player-name" placeholder="Tên của bạn">
        <button onclick="saveResult()">Lưu Kết Quả & Xem Bảng Xếp Hạng</button>
    </div>

    <hr>

    <div id="leaderboard-area">
        <h2>Bảng Xếp Hạng</h2>
        <table class="leaderboard-table">
            <thead>
                <tr>
                    <th>Hạng</th>
                    <th>Tên</th>
                    <th>Điểm</th>
                    <th>Thời gian</th>
                    <th>Đúng/Tổng</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
                </tbody>
        </table>
        <button onclick="resetGame()">Thiết Lập Lại Trò Chơi</button>
    </div>

    <footer id="main-footer">
        <p>Liên hệ Zalo: <a href="https://zalo.me/0796750236" target="_blank">0796750236</a></p>
    </footer>

</div>

<script>
// Biến toàn cục
let questions = []; // Lưu trữ { imageUrl: String, answer: String }
let currentQuestionIndex = 0;
let startTime = null;
let totalTime = 0;
let correctAnswers = 0;
let db; // Biến cho IndexedDB

// Hằng số cho tên lưu trữ
const STORAGE_KEY_LEADERBOARD = 'captchaGameLeaderboard';
const DB_NAME = 'CaptchaGameDB';
const DB_VERSION = 1;
const STORE_NAME = 'setupStore';
const SETUP_KEY = 'currentSetup';

// --- HÀM HỖ TRỢ INDEXEDDB ---

function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onupgradeneeded = (event) => {
            db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME);
            }
        };

        request.onsuccess = (event) => {
            db = event.target.result;
            resolve(db);
        };

        request.onerror = (event) => {
            reject('Lỗi IndexedDB: ' + event.target.errorCode);
        };
    });
}

function getDBData(key) {
    return new Promise(async (resolve, reject) => {
        try {
            const dbInstance = await openDB();
            const transaction = dbInstance.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(key);

            request.onsuccess = (event) => {
                resolve(event.target.result);
            };

            request.onerror = (event) => {
                reject('Lỗi đọc dữ liệu IndexedDB: ' + event.target.error);
            };
        } catch (error) {
            reject(error);
        }
    });
}

function setDBData(key, value) {
    return new Promise(async (resolve, reject) => {
        try {
            const dbInstance = await openDB();
            const transaction = dbInstance.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            
            const request = store.put(value, key);

            request.onsuccess = () => {
                resolve();
            };

            request.onerror = (event) => {
                reject('Lỗi ghi dữ liệu IndexedDB: ' + event.target.error);
            };

        } catch (error) {
            reject(error);
        }
    });
}

function deleteDBData(key) {
    return new Promise(async (resolve, reject) => {
        try {
            const dbInstance = await openDB();
            const transaction = dbInstance.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            
            const request = store.delete(key);

            request.onsuccess = () => {
                resolve();
            };

            request.onerror = (event) => {
                reject('Lỗi xóa dữ liệu IndexedDB: ' + event.target.error);
            };
        } catch (error) {
            reject(error);
        }
    });
}

// --- HÀM HỖ TRỢ ĐỌC TỆP ---

function readFilesAndAnswers(files, answers) {
    return new Promise((resolve, reject) => {
        if (files.length === 0) {
            return reject('Vui lòng tải lên ít nhất một hình ảnh.');
        }

        if (files.length !== answers.length) {
            return reject(`Số lượng hình ảnh (${files.length}) không khớp với số lượng đáp án (${answers.length}).`);
        }
        
        const loadedQuestions = [];
        let loadedCount = 0;

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const reader = new FileReader();
            
            reader.onload = (e) => {
                loadedQuestions.push({
                    imageUrl: e.target.result, // Data URL
                    answer: answers[i].toLowerCase()
                });
                loadedCount++;
                
                if (loadedCount === files.length) {
                    resolve(loadedQuestions);
                }
            };

            reader.onerror = () => reject(`Lỗi khi đọc tệp: ${file.name}`);
            reader.readAsDataURL(file);
        }
    });
}

// --- CHỨC NĂNG 1A: LƯU TRỮ VÀ TẢI LẠI THIẾT LẬP (IndexedDB) ---

async function saveSetup() {
    const fileInput = document.getElementById('image-upload');
    const answersInput = document.getElementById('answers-input');
    const statusDiv = document.getElementById('setup-status');
    
    const files = fileInput.files;
    const answers = answersInput.value.split(',').map(a => a.trim()).filter(a => a !== '');

    if (files.length === 0 || files.length !== answers.length) {
        statusDiv.textContent = 'Lỗi: Vui lòng tải lên hình ảnh và nhập đáp án khớp trước khi lưu.';
        return;
    }

    statusDiv.textContent = 'Đang tải và lưu trữ thiết lập vào IndexedDB...';

    try {
        const loadedQuestions = await readFilesAndAnswers(files, answers);
        const setupData = {
            questions: loadedQuestions,
            answersString: answersInput.value
        };
        
        await setDBData(SETUP_KEY, setupData);
        statusDiv.textContent = `Thành công! Đã lưu trữ ${loadedQuestions.length} cặp câu hỏi/đáp án vào IndexedDB.`;
    } catch (error) {
        statusDiv.textContent = `Lỗi khi lưu trữ: ${error}`;
        console.error("Save Setup Error:", error);
    }
}

async function loadSetup() {
    const statusDiv = document.getElementById('setup-status');
    statusDiv.textContent = 'Đang tải thiết lập từ IndexedDB...';

    try {
        const setupData = await getDBData(SETUP_KEY);

        if (!setupData || setupData.questions.length === 0) {
            statusDiv.textContent = 'Lỗi: Không tìm thấy thiết lập nào đã lưu hoặc thiết lập trống.';
            return;
        }

        questions = setupData.questions;
        document.getElementById('answers-input').value = setupData.answersString;
        
        document.getElementById('total-questions').textContent = questions.length;
        document.getElementById('setup-area').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';
        
        questions.sort(() => Math.random() - 0.5);
        statusDiv.textContent = `Thành công! Đã tải ${questions.length} câu hỏi đã lưu.`;
        startGame();

    } catch (e) {
        statusDiv.textContent = `Lỗi khi tải thiết lập: ${e}`;
        console.error("Load Setup Error:", e);
    }
}

async function clearSavedSetup() {
    const statusDiv = document.getElementById('setup-status');
    statusDiv.textContent = 'Đang xóa thiết lập trong IndexedDB...';

    try {
        await deleteDBData(SETUP_KEY);
        statusDiv.textContent = 'Thiết lập Captcha đã lưu (bao gồm hình ảnh) đã được xóa khỏi IndexedDB.';
    } catch (error) {
        statusDiv.textContent = `Lỗi khi xóa: ${error}`;
        console.error("Clear Setup Error:", error);
    }
    document.getElementById('image-upload').value = null; 
    document.getElementById('answers-input').value = ''; 
}


// --- CHỨC NĂNG 1B: BẮT ĐẦU TRÒ CHƠI VỚI DỮ LIỆU TẢI LÊN MỚI ---

async function checkSetup() {
    const fileInput = document.getElementById('image-upload');
    const answersInput = document.getElementById('answers-input');
    const statusDiv = document.getElementById('setup-status');

    const files = fileInput.files;
    const answers = answersInput.value.split(',').map(a => a.trim()).filter(a => a !== '');

    statusDiv.textContent = 'Đang kiểm tra và thiết lập...';

    try {
        const loadedQuestions = await readFilesAndAnswers(files, answers);
        questions = loadedQuestions;
        questions.sort(() => Math.random() - 0.5);
        
        statusDiv.textContent = `Thành công! Đã thiết lập ${questions.length} câu hỏi. Sẵn sàng chơi.`;
        document.getElementById('total-questions').textContent = questions.length;
        
        document.getElementById('setup-area').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';
        startGame();
    } catch (error) {
        statusDiv.textContent = `Lỗi: ${error}`;
    }
}

// --- CHỨC NĂNG 2, 3, 4: TRÒ CHƠI, KẾT QUẢ & BẢNG XẾP HẠNG ---

function startGame() {
    currentQuestionIndex = 0;
    correctAnswers = 0;
    totalTime = 0;
    startTime = Date.now();
    loadNextQuestion();
}

function loadNextQuestion() {
    document.getElementById('captcha-input').value = '';
    document.getElementById('captcha-input').focus();
    
    if (currentQuestionIndex < questions.length) {
        document.getElementById('captcha-display').src = questions[currentQuestionIndex].imageUrl;
        document.getElementById('current-question-index').textContent = currentQuestionIndex + 1;
        
        if (currentQuestionIndex === 0) {
            updateTimer();
        }
    } else {
        endGame();
    }
}

let timerInterval;
function updateTimer() {
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        if (startTime) {
            totalTime = (Date.now() - startTime) / 1000;
            document.getElementById('game-timer').textContent = totalTime.toFixed(2);
        }
    }, 100);
}

function handleEnter(event) {
    if (event.key === 'Enter') {
        submitAnswer();
    }
}

function submitAnswer() {
    if (currentQuestionIndex >= questions.length) return;

    const userInput = document.getElementById('captcha-input').value.trim().toLowerCase();
    const correctAnswer = questions[currentQuestionIndex].answer;
    
    if (userInput === correctAnswer) {
        correctAnswers++;
        document.getElementById('captcha-input').style.backgroundColor = '#ccffcc';
    } else {
        document.getElementById('captcha-input').style.backgroundColor = '#ffcccc';
    }
    
    setTimeout(() => {
        document.getElementById('captcha-input').style.backgroundColor = 'white';
        currentQuestionIndex++;
        loadNextQuestion();
    }, 300);
}

function endGame() {
    clearInterval(timerInterval);
    startTime = null;
    
    document.getElementById('game-area').style.display = 'none';
    document.getElementById('result-area').style.display = 'block';

    const accuracy = correctAnswers / questions.length;
    // Điểm số: (Độ chính xác * 10000) / (Thời gian (giây) + 1)
    const score = (accuracy * 10000) / (totalTime + 1); 

    document.getElementById('final-time').textContent = totalTime.toFixed(2);
    document.getElementById('correct-count').textContent = `${correctAnswers} / ${questions.length} (${(accuracy * 100).toFixed(1)}%)`;
    document.getElementById('final-score').textContent = score.toFixed(0);
}

function getLeaderboard() {
    const leaderboard = localStorage.getItem(STORAGE_KEY_LEADERBOARD);
    return leaderboard ? JSON.parse(leaderboard) : [];
}

function saveLeaderboard(leaderboard) {
    localStorage.setItem(STORAGE_KEY_LEADERBOARD, JSON.stringify(leaderboard));
}

function saveResult() {
    const playerName = document.getElementById('player-name').value.trim();
    if (playerName === '') {
        alert('Vui lòng nhập tên của bạn để lưu kết quả!');
        return;
    }

    const accuracy = correctAnswers / questions.length;
    const score = (accuracy * 10000) / (totalTime + 1); 

    const newRecord = {
        name: playerName,
        score: parseFloat(score.toFixed(0)),
        time: parseFloat(totalTime.toFixed(2)),
        correct: correctAnswers,
        total: questions.length,
        timestamp: new Date().toISOString()
    };

    let leaderboard = getLeaderboard();
    leaderboard.push(newRecord);
    
    // Sắp xếp: Điểm cao hơn trước. Nếu điểm bằng nhau, thời gian thấp hơn trước.
    leaderboard.sort((a, b) => {
        if (b.score !== a.score) {
            return b.score - a.score;
        }
        return a.time - b.time;
    });

    saveLeaderboard(leaderboard);

    document.getElementById('result-area').style.display = 'none';
    document.getElementById('leaderboard-area').style.display = 'block';
    displayLeaderboard(leaderboard);
}

function displayLeaderboard(leaderboard) {
    const tbody = document.getElementById('leaderboard-body');
    tbody.innerHTML = '';

    if (leaderboard.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Chưa có người chơi nào.</td></tr>';
        return;
    }

    leaderboard.forEach((record, index) => {
        const row = tbody.insertRow();
        row.insertCell().textContent = index + 1;
        row.insertCell().textContent = record.name;
        row.insertCell().textContent = record.score;
        row.insertCell().textContent = record.time.toFixed(2) + 's';
        row.insertCell().textContent = `${record.correct}/${record.total}`;
    });
}

function resetGame() {
    document.getElementById('setup-area').style.display = 'block';
    document.getElementById('game-area').style.display = 'none';
    document.getElementById('result-area').style.display = 'none';
    document.getElementById('leaderboard-area').style.display = 'none';
    
    document.getElementById('image-upload').value = null;
    document.getElementById('answers-input').value = '';
    document.getElementById('setup-status').textContent = '';
    document.getElementById('player-name').value = '';

    displayLeaderboard(getLeaderboard());
}

window.onload = () => {
    // Khởi tạo IndexedDB khi tải trang
    openDB().catch(e => {
        document.getElementById('setup-status').textContent = `Lỗi khởi tạo cơ sở dữ liệu: ${e}. Chức năng lưu/tải thiết lập sẽ không hoạt động.`;
    });
    displayLeaderboard(getLeaderboard());
    document.getElementById('leaderboard-area').style.display = 'none';
}
</script>

</body>
</html>